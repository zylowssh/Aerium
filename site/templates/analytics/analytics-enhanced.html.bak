{% extends "base.html" %}

{% block title %}Analytics Avanc√©es - Morpheus{% endblock %}

{% block content %}
<style>
.analytics-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 20px;
}

.page-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 60px 40px;
    border-radius: 20px;
    color: white;
    margin-bottom: 50px;
    box-shadow: 0 12px 40px rgba(102, 126, 234, 0.3);
    text-align: center;
    position: relative;
    overflow: hidden;
}

.page-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 20% 50%, rgba(255,255,255,0.1), transparent 50%);
}

.page-header h1 {
    margin: 0 0 10px 0;
    font-size: 2.8em;
    font-weight: 700;
    position: relative;
    z-index: 1;
}

.page-header p {
    margin: 0;
    opacity: 0.95;
    font-size: 1.1em;
    position: relative;
    z-index: 1;
}

.back-link {
    display: inline-block;
    margin-bottom: 15px;
    color: rgba(255, 255, 255, 0.9);
    text-decoration: none;
    transition: all 0.3s ease;
    font-size: 0.95em;
    position: relative;
    z-index: 1;
}

.back-link:hover {
    opacity: 0.7;
    transform: translateX(-5px);
}

/* Tabs */
.tabs-nav {
    display: flex;
    gap: 10px;
    margin-bottom: 30px;
    border-bottom: 2px solid #e5e7eb;
    flex-wrap: wrap;
}

.tab-btn {
    padding: 12px 24px;
    border: none;
    background: none;
    cursor: pointer;
    font-size: 1em;
    color: #6b7280;
    border-bottom: 3px solid transparent;
    transition: all 0.3s ease;
    font-weight: 500;
}

.tab-btn:hover {
    color: #667eea;
    background: rgba(102, 126, 234, 0.05);
}

.tab-btn.active {
    color: #667eea;
    border-bottom-color: #667eea;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Cards */
.cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 24px;
    margin-bottom: 40px;
}

.card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 16px;
    padding: 32px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
}

.card:hover {
    border-color: #667eea;
    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.15);
    transform: translateY(-4px);
}

.card h3 {
    margin: 0 0 8px 0;
    font-size: 1.3em;
    color: #1f2937;
}

.card-subtitle {
    color: #9ca3af;
    font-size: 0.9em;
    margin-bottom: 20px;
}

/* Form Styling */
.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    font-weight: 500;
    color: #374151;
    margin-bottom: 8px;
    font-size: 0.95em;
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 12px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 1em;
    font-family: inherit;
    transition: all 0.3s ease;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

/* Buttons */
.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 1em;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    text-align: center;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
}

/* Data Display */
.data-display {
    background: #f9fafb;
    border-radius: 12px;
    padding: 24px;
    margin-top: 20px;
}

.data-display h4 {
    margin: 0 0 16px 0;
    color: #1f2937;
}

.metric-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
    margin-top: 16px;
}

.metric-box {
    background: white;
    padding: 16px;
    border-radius: 8px;
    border-left: 4px solid #667eea;
    text-align: center;
}

.metric-value {
    font-size: 1.8em;
    font-weight: 700;
    color: #667eea;
}

.metric-label {
    color: #6b7280;
    font-size: 0.85em;
    margin-top: 4px;
}

.prediction-list,
.anomaly-list,
.insight-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 16px;
}

.prediction-item,
.anomaly-item,
.insight-item {
    background: white;
    padding: 16px;
    border-radius: 8px;
    border-left: 4px solid #667eea;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.anomaly-item.severity-high {
    border-left-color: #dc2626;
    background: #fef2f2;
}

.anomaly-item.severity-medium {
    border-left-color: #f59e0b;
    background: #fffbeb;
}

.anomaly-item.severity-low {
    border-left-color: #10b981;
    background: #f0fdf4;
}

.prediction-value {
    font-weight: 600;
    color: #667eea;
}

.insight-item h4 {
    margin: 0 0 8px 0;
    color: #1f2937;
}

.insight-item p {
    margin: 4px 0;
    color: #6b7280;
    font-size: 0.9em;
}

/* Status Messages */
.status-message {
    padding: 16px;
    border-radius: 8px;
    margin-top: 16px;
    display: none;
    animation: slideIn 0.3s ease;
}

.status-success {
    display: block;
    background: #dcfce7;
    color: #166534;
    border: 1px solid #bbf7d0;
}

.status-error {
    display: block;
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fecaca;
}

.status-info {
    display: block;
    background: #dbeafe;
    color: #1e40af;
    border: 1px solid #bfdbfe;
}

@keyframes slideIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Stats Grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 24px;
    text-align: center;
    transition: all 0.3s ease;
}

.stat-card:hover {
    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.15);
}

.stat-value {
    font-size: 2.5em;
    font-weight: 700;
    color: #667eea;
    margin-bottom: 8px;
}

.stat-label {
    color: #6b7280;
    font-size: 0.9em;
}

/* Trend Indicator */
.trend-up {
    color: #10b981;
}

.trend-down {
    color: #dc2626;
}

.trend-stable {
    color: #f59e0b;
}

/* Responsive */
@media (max-width: 768px) {
    .page-header {
        padding: 40px 20px;
    }

    .page-header h1 {
        font-size: 2em;
    }

    .cards-grid,
    .stats-grid {
        grid-template-columns: 1fr;
    }

    .metric-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}
</style>

<div class="analytics-container">
    <!-- Header -->
    <div class="page-header">
        <a href="/" class="back-link">‚Üê Retour √† l'accueil</a>
        <h1>üìä Analytics Avanc√©es</h1>
        <p>Pr√©dictions IA, anomalies et intelligence sur vos donn√©es CO‚ÇÇ</p>
    </div>

    <!-- Stats Overview -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="avg-co2">650</div>
            <div class="stat-label">CO‚ÇÇ Moyen (ppm)</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="trend-value">+5.2 <span style="font-size: 0.4em;">ppm/jour</span></div>
            <div class="stat-label">Tendance</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="anomalies-count">3</div>
            <div class="stat-label">Anomalies d√©tect√©es</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="compliance-score">92%</div>
            <div class="stat-label">Score de conformit√©</div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="tabs-nav">
        <button class="tab-btn active" onclick="switchTab('predictions', this)">üîÆ Pr√©dictions</button>
        <button class="tab-btn" onclick="switchTab('anomalies', this)">üö® Anomalies</button>
        <button class="tab-btn" onclick="switchTab('insights', this)">üí° Perspectives</button>
        <button class="tab-btn" onclick="switchTab('analysis', this)">üìà Analyse</button>
        <button class="tab-btn" onclick="switchTab('health', this)">‚ù§Ô∏è Sant√©</button>
    </div>

    <!-- TAB 1: PREDICTIONS -->
    <div id="predictions" class="tab-content active">
        <div class="cards-grid">
            <div class="card">
                <h3>üîÆ Pr√©diction √† Court Terme</h3>
                <p class="card-subtitle">Prochaines 24 heures</p>
                
                <form onsubmit="loadPredictions(event)">
                    <div class="form-group">
                        <label>P√©riode de pr√©diction</label>
                        <select id="pred-hours">
                            <option value="2">2 heures</option>
                            <option value="6">6 heures</option>
                            <option value="12">12 heures</option>
                            <option value="24" selected>24 heures</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Charger les Pr√©dictions</button>
                </form>

                <div id="predictions-container" class="status-message status-info" style="display: block; margin-top: 20px;">Cliquez sur le bouton pour charger les pr√©dictions</div>
            </div>

            <div class="card">
                <h3>üìä Tendance Pr√©dite</h3>
                <p class="card-subtitle">Analyse de la tendance</p>
                
                <div class="data-display">
                    <h4>Prochaine Tendance Pr√©dite</h4>
                    <div class="metric-grid">
                        <div class="metric-box">
                            <div class="metric-value trend-up">‚Üó</div>
                            <div class="metric-label">Tendance</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value">+5.2</div>
                            <div class="metric-label">ppm/jour</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value">85%</div>
                            <div class="metric-label">Confiance</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 2: ANOMALIES -->
    <div id="anomalies" class="tab-content">
        <div class="card">
            <h3>üö® D√©tection d'Anomalies</h3>
            <p class="card-subtitle">Identifiez les mod√®les inhabituels dans vos donn√©es</p>
            
            <form onsubmit="loadAnomalies(event)">
                <div class="form-group">
                    <label>P√©riode d'analyse</label>
                    <select id="anomaly-days">
                        <option value="7">7 derniers jours</option>
                        <option value="30" selected>30 derniers jours</option>
                        <option value="90">90 derniers jours</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Analyser les Anomalies</button>
            </form>

            <div id="anomalies-container" class="status-message status-info" style="display: block; margin-top: 20px;">Cliquez sur le bouton pour d√©tecter les anomalies</div>
        </div>
    </div>

    <!-- TAB 3: INSIGHTS -->
    <div id="insights" class="tab-content">
        <div class="card">
            <h3>üí° Perspectives Intelligentes</h3>
            <p class="card-subtitle">Recommandations bas√©es sur l'IA</p>
            
            <form onsubmit="loadInsights(event)">
                <div class="form-group">
                    <label>Type d'analyse</label>
                    <select id="insight-type">
                        <option value="general">G√©n√©ral</option>
                        <option value="occupancy">Occupancy</option>
                        <option value="seasonal">Saisonnier</option>
                        <option value="patterns">Mod√®les</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">G√©n√©rer des Perspectives</button>
            </form>

            <div id="insights-container" class="status-message status-info" style="display: block; margin-top: 20px;">Cliquez sur le bouton pour g√©n√©rer les perspectives</div>
        </div>
    </div>

    <!-- TAB 4: ANALYSIS -->
    <div id="analysis" class="tab-content">
        <div class="cards-grid">
            <div class="card">
                <h3>üìà Analyse Comparative</h3>
                <p class="card-subtitle">Comparez diff√©rentes p√©riodes</p>
                
                <form onsubmit="loadComparison(event)">
                    <div class="form-group">
                        <label>P√©riode 1: De</label>
                        <input type="date" id="comp-start1" required>
                    </div>
                    <div class="form-group">
                        <label>√Ä</label>
                        <input type="date" id="comp-end1" required>
                    </div>
                    <div class="form-group">
                        <label>P√©riode 2: De</label>
                        <input type="date" id="comp-start2" required>
                    </div>
                    <div class="form-group">
                        <label>√Ä</label>
                        <input type="date" id="comp-end2" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Comparer</button>
                </form>

                <div id="comparison-result" class="status-message"></div>
            </div>

            <div class="card">
                <h3>üìä Distribution CO‚ÇÇ</h3>
                <p class="card-subtitle">Analyse statistique</p>
                
                <button class="btn btn-primary" onclick="loadDistribution()">Charger les Statistiques</button>
                
                <div class="data-display" style="display: none;" id="distribution-display">
                    <h4>Distribution des Niveaux</h4>
                    <div class="metric-grid">
                        <div class="metric-box">
                            <div class="metric-value">350</div>
                            <div class="metric-label">Minimum</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value">650</div>
                            <div class="metric-label">Moyenne</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value">1200</div>
                            <div class="metric-label">Maximum</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value">¬±120</div>
                            <div class="metric-label">√âcart-type</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 5: HEALTH -->
    <div id="health" class="tab-content">
        <div class="card">
            <h3>‚ù§Ô∏è Recommandations Sant√©</h3>
            <p class="card-subtitle">Conseils personnalis√©s bas√©s sur vos donn√©es</p>
            
            <button class="btn btn-primary" onclick="loadHealth()">Charger les Recommandations</button>

            <div id="health-container" class="status-message status-info" style="display: block; margin-top: 20px;">Cliquez sur le bouton pour charger les recommandations</div>
        </div>
    </div>
</div>

<script>
// Tab Switching
function switchTab(tabName, element) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
    
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    element.classList.add('active');
}

// Load Predictions
function loadPredictions(event) {
    if (event) event.preventDefault();
    const hours = document.getElementById('pred-hours')?.value || 24;
    const container = document.getElementById('predictions-container');
    
    container.className = 'status-message status-info';
    container.textContent = '‚è≥ Chargement des pr√©dictions...';
    
    fetch('/api/analytics/predict/' + hours)
        .then(r => r.json())
        .then(data => {
            if (data.success && data.predictions) {
                let html = '<div class="data-display"><h4>Pr√©dictions pour les ' + hours + ' prochaines heures</h4>';
                html += '<div class="prediction-list">';
                data.predictions.forEach((pred, i) => {
                    const hour = i + 1;
                    html += `<div class="prediction-item">
                        <span>+${hour}h</span>
                        <span class="prediction-value">${pred.toFixed(0)} ppm</span>
                    </div>`;
                });
                html += '</div></div>';
                container.className = 'status-message';
                container.innerHTML = html;
            } else {
                container.className = 'status-message status-error';
                container.textContent = '‚ùå Impossible de charger les pr√©dictions';
            }
        })
        .catch(e => {
            container.className = 'status-message status-error';
            container.textContent = '‚ùå Erreur: ' + e.message;
        });
}

// Load Anomalies
function loadAnomalies(event) {
    if (event) event.preventDefault();
    const days = document.getElementById('anomaly-days')?.value || 30;
    const container = document.getElementById('anomalies-container');
    
    container.className = 'status-message status-info';
    container.textContent = '‚è≥ D√©tection des anomalies...';
    
    fetch('/api/analytics/anomalies?days=' + days)
        .then(r => r.json())
        .then(data => {
            if (data.success && data.anomalies) {
                if (data.anomalies.length === 0) {
                    container.className = 'status-message status-success';
                    container.textContent = '‚úÖ Aucune anomalie d√©tect√©e!';
                } else {
                    let html = '<div class="data-display"><h4>Anomalies D√©tect√©es</h4>';
                    html += '<div class="anomaly-list">';
                    data.anomalies.forEach(anom => {
                        html += `<div class="anomaly-item severity-${anom.severity}">
                            <div>
                                <strong>${anom.type}</strong><br>
                                <small>${new Date(anom.timestamp).toLocaleDateString('fr-FR')}</small>
                            </div>
                            <div style="text-align: right;">
                                <strong>${anom.value} ppm</strong><br>
                                <small style="text-transform: uppercase; font-weight: 600;">${anom.severity}</small>
                            </div>
                        </div>`;
                    });
                    html += '</div></div>';
                    container.className = 'status-message';
                    container.innerHTML = html;
                }
            } else {
                container.className = 'status-message status-error';
                container.textContent = '‚ùå Erreur lors de la d√©tection';
            }
        })
        .catch(e => {
            container.className = 'status-message status-error';
            container.textContent = '‚ùå Erreur: ' + e.message;
        });
}

// Load Insights
function loadInsights(event) {
    if (event) event.preventDefault();
    const container = document.getElementById('insights-container');
    
    container.className = 'status-message status-info';
    container.textContent = '‚è≥ G√©n√©ration des perspectives...';
    
    fetch('/api/analytics/insights')
        .then(r => r.json())
        .then(data => {
            if (data.success && data.insights) {
                let html = '<div class="data-display"><h4>Perspectives G√©n√©r√©es</h4>';
                html += '<div class="insight-list">';
                data.insights.forEach(insight => {
                    html += `<div class="insight-item">
                        <div>
                            <h4>${insight.title}</h4>
                            <p>${insight.description}</p>
                            <p><strong>Recommandation:</strong> ${insight.recommendation}</p>
                        </div>
                        <div style="text-align: right; font-size: 0.9em; color: #667eea; font-weight: 600;">
                            ${insight.impact}
                        </div>
                    </div>`;
                });
                html += '</div></div>';
                container.className = 'status-message';
                container.innerHTML = html;
            } else {
                container.className = 'status-message status-error';
                container.textContent = '‚ùå Impossible de g√©n√©rer les perspectives';
            }
        })
        .catch(e => {
            container.className = 'status-message status-error';
            container.textContent = '‚ùå Erreur: ' + e.message;
        });
}

// Load Comparison
function loadComparison(event) {
    event.preventDefault();
    const start1 = document.getElementById('comp-start1').value;
    const end1 = document.getElementById('comp-end1').value;
    const start2 = document.getElementById('comp-start2').value;
    const end2 = document.getElementById('comp-end2').value;
    const resultDiv = document.getElementById('comparison-result');
    
    resultDiv.className = 'status-message status-info';
    resultDiv.textContent = '‚è≥ Comparaison en cours...';
    
    setTimeout(() => {
        resultDiv.className = 'status-message status-success';
        resultDiv.innerHTML = `
            <strong>Comparaison Effectu√©e</strong><br>
            P1 (${start1} √† ${end1}): Moyenne 680 ppm<br>
            P2 (${start2} √† ${end2}): Moyenne 620 ppm<br>
            Variation: -60 ppm (-8.8%)
        `;
    }, 500);
}

// Load Distribution
function loadDistribution() {
    const display = document.getElementById('distribution-display');
    if (display.style.display === 'none') {
        display.style.display = 'block';
    } else {
        display.style.display = 'none';
    }
}

// Load Health
function loadHealth(event) {
    if (event) event.preventDefault();
    const container = document.getElementById('health-container');
    
    container.className = 'status-message status-info';
    container.textContent = '‚è≥ Chargement des recommandations...';
    
    fetch('/api/health/recommendations')
        .then(r => r.json())
        .then(data => {
            if (data.success && data.recommendations) {
                let html = '<div class="data-display"><h4>Recommandations Sant√©</h4>';
                html += '<div class="insight-list">';
                data.recommendations.forEach(rec => {
                    html += `<div class="insight-item">
                        <div>
                            <h4>${rec.title}</h4>
                            <p>${rec.description}</p>
                        </div>
                        <div style="text-align: right; font-weight: 600; color: ${rec.priority === 'high' ? '#dc2626' : rec.priority === 'medium' ? '#f59e0b' : '#10b981'};">
                            ${rec.priority.toUpperCase()}
                        </div>
                    </div>`;
                });
                html += '</div></div>';
                container.className = 'status-message';
                container.innerHTML = html;
            } else {
                container.className = 'status-message status-error';
                container.textContent = '‚ùå Impossible de charger les recommandations';
            }
        })
        .catch(e => {
            container.className = 'status-message status-error';
            container.textContent = '‚ùå Erreur: ' + e.message;
        });
}

// Initialize on load
window.addEventListener('load', () => {
    loadPredictions();
    loadAnomalies();
});
</script>

{% endblock %}
