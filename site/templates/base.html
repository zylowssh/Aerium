<!DOCTYPE html>
<html lang="fr" class="dark-mode">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="Aerium - Surveillance intelligente de la qualitÃ© de l'air COâ‚‚ en temps rÃ©el" />
    <meta name="theme-color" content="#0b0d12" />
    <title>Aerium - QualitÃ© de l'air COâ‚‚</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Aerium" />
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/icon-192.png') }}" />
    <!-- Critical inline styles to prevent flash - applied before any external CSS -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/theme-init.css') }}"
    />
    <link
      rel="icon"
      href="{{ url_for('static', filename='images/favicon.ico') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/profile-admin.css') }}"
    />
    <!-- Enhanced UI Styles -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/enhanced-ui.css') }}"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
    <!-- Apply saved theme immediately to prevent flash of wrong theme -->
    <script src="{{ url_for('static', filename='js/theme-init.js') }}"></script>
    <!-- UX Enhancements -->
    <script src="{{ url_for('static', filename='js/keyboard-shortcuts.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tooltips.js') }}"></script>
    <script src="{{ url_for('static', filename='js/form-validation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/global-search.js') }}"></script>
    <script>
      // Simple loader: show during navigation and form submits
      (function(){
        const loader = document.getElementById('global-loader');
        function show(){ if(loader) { loader.style.display='flex'; } }
        function hide(){ if(loader) { loader.style.display='none'; } }
        window.addEventListener('beforeunload', show);
        document.addEventListener('click', function(evt){
          const a = evt.target.closest('a');
          if(a && a.href && a.target !== '_blank') { show(); }
        });
        document.addEventListener('submit', function(){ show(); });
        window.addEventListener('load', hide);
      })();
      
      // Register Service Worker for PWA
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then(reg => console.log('Service Worker registered'))
            .catch(err => console.log('SW registration failed:', err));
        });
      }
    </script>
  </head>
  <body>
    <nav class="navbar" role="navigation" aria-label="Navigation principale">
      <div class="nav-left">
        <img
          id="nav-logo-img"
          src="{{ url_for('static', filename='images/logoWhite.png') }}"
          alt="Aerium"
          class="nav-logo"
        />
        
        <!-- Global Search (Left Side) -->
        <div style="position:relative; margin-left:20px;">
          <input 
            type="text" 
            id="global-search-input" 
            placeholder="Rechercher... (/)" 
            data-tooltip="Appuyez sur / ou Ctrl+K pour rechercher"
            style="width:280px; padding:9px 38px 9px 14px; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.2); border-radius:8px; color:#fff; font-size:0.9rem; transition:all 0.3s;"
            onfocus="this.style.background='rgba(255,255,255,0.12)'; this.style.borderColor='rgba(77,184,255,0.5)'"
            onblur="this.style.background='rgba(255,255,255,0.08)'; this.style.borderColor='rgba(255,255,255,0.2)'"
          />
          <span style="position:absolute; right:12px; top:50%; transform:translateY(-50%); opacity:0.6; pointer-events:none; font-size:1.1rem;">ğŸ”</span>
        </div>
      </div>

      <div class="nav-center">
        <a href="/">ğŸ  Vue d'ensemble</a>
        <a href="/live">ğŸ“Š Live</a>
        <a href="/simulator">ğŸ”¬ Simulateur</a>
        
        <!-- Data & Monitoring Dropdown -->
        <div class="nav-dropdown">
          <button class="nav-dropdown-btn" aria-haspopup="true" aria-expanded="false">ğŸ“ˆ DonnÃ©es</button>
          <div class="nav-dropdown-menu" role="menu">
            <a href="/sensors" role="menuitem">ğŸ“¡ Capteurs</a>
            <a href="/visualization" role="menuitem">ğŸ“Š Visualisations</a>
            <a href="/export" role="menuitem">ğŸ“¤ Export</a>
          </div>
        </div>

        <!-- Insights Dropdown -->
        <div class="nav-dropdown">
          <button class="nav-dropdown-btn" aria-haspopup="true" aria-expanded="false">ğŸ’¡ Insights</button>
          <div class="nav-dropdown-menu" role="menu">
            <a href="/analytics" role="menuitem">ğŸ“Š Analytics</a>
            <a href="/health" role="menuitem">ğŸ’š SantÃ©</a>
            <a href="/performance" role="menuitem">âš¡ Performance</a>
          </div>
        </div>

        <a href="/collaboration">ğŸ‘¥ Collaboration</a>
        <a href="/settings">âš™ï¸ ParamÃ¨tres</a>
        
        {% if session.get('username') %}
        <a href="{{ url_for('main.onboarding_page') }}">ğŸ“– Guide</a>
        {% endif %}
        {% if session.get('username') and current_user_is_admin %}
        <a href="/admin-tools">ğŸ› ï¸ Admin</a>
        {% endif %}
        <span class="nav-underline"></span>
      </div>

      <div class="nav-right">
        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle" aria-label="Ouvrir le menu" aria-expanded="false" data-tooltip="Menu">â˜°</button>
        <button id="theme-toggle-btn" class="theme-toggle" title="Basculer le thÃ¨me" aria-label="Basculer le thÃ¨me sombre/clair" data-tooltip="ThÃ¨me sombre/clair">
          <span class="theme-icon" aria-hidden="true">ğŸŒ™</span>
        </button>
        <div class="nav-status" id="nav-analysis" data-tooltip="Ã‰tat de connexion en temps rÃ©el">
          <span class="dot"></span>
          <div class="nav-status-text">
            <span class="label" id="nav-analysis-label">Analyse active</span>
            <span class="sublabel" id="nav-transport-label">Live via WebSocket</span>
          </div>
        </div>
        <div class="nav-mini" id="nav-mini">
          <span class="nav-mini-value" id="nav-ppm-value">â€” ppm</span>
          <canvas id="nav-ppm-spark" width="160" height="48" aria-label="Historique COâ‚‚"></canvas>
        </div>
        {% if session.get('username') %}
        <div class="nav-user">
          <a href="{{ url_for('auth.profile') }}" class="nav-profile-link" title="Profil" data-tooltip="Voir mon profil">ğŸ‘¤ {{ session.get('username') }}</a>
          <a href="{{ url_for('auth.logout') }}" class="nav-logout" title="DÃ©connexion" data-tooltip="Se dÃ©connecter">ğŸšª</a>
        </div>
        {% endif %}
      </div>
    </nav>

    <!-- Global Loading Overlay -->
    <div id="global-loader" aria-live="polite" aria-busy="true" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:9999; align-items:center; justify-content:center;">
      <div style="background:#0b0d12; color:#fff; padding:16px 24px; border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,0.4);">
        Chargement...
      </div>
    </div>

    <!-- Mobile Navigation Menu -->
    <div class="mobile-menu" role="dialog" aria-label="Menu mobile">
      <a href="/">ğŸ  Vue d'ensemble</a>
      <a href="/live">ğŸ“Š Live</a>
      <a href="/simulator">ğŸ”¬ Simulateur</a>
      <a href="/sensors">ğŸ“¡ Capteurs</a>
      <a href="/settings">âš™ï¸ ParamÃ¨tres</a>
      <a href="/analytics">ğŸ“Š Analytics</a>
      <a href="/health">ğŸ’š SantÃ©</a>
      <a href="/export">ğŸ“¤ Export</a>
      <a href="/data-export">ğŸ“¥ Export AvancÃ©</a>
      <a href="/gdpr/profile">ğŸ”’ Mes DonnÃ©es (GDPR)</a>
      <a href="/collaboration">ğŸ‘¥ Collaboration</a>
      <a href="/performance">âš¡ Performance</a>
      <a href="/api/v2/docs">ğŸ“– Documentation API</a>
      {% if session.get('username') %}
      <hr style="border: none; border-top: 1px solid rgba(255, 255, 255, 0.1); margin: 10px 0;">
      <a href="{{ url_for('main.onboarding_page') }}">ğŸ“– Guide</a>
      {% if current_user_is_admin %}
      <a href="/admin-tools">ğŸ› ï¸ Outils Admin</a>
      <a href="/gdpr/admin">ğŸ”’ GDPR Admin</a>
      {% endif %}
      <a href="{{ url_for('auth.profile') }}">ğŸ‘¤ Profil</a>
      <a href="{{ url_for('auth.logout') }}">ğŸšª DÃ©connexion</a>
      {% else %}
      <a href="{{ url_for('auth.login_page') }}">ğŸ” Se connecter</a>
      <a href="{{ url_for('auth.register_page') }}">ğŸ“ S'inscrire</a>
      {% endif %}
    </div>

    <main class="container">{% block content %}{% endblock %}</main>
    {% block scripts %}{% endblock %}

    <!-- Module Loading Order (DO NOT CHANGE) -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script defer src="{{ url_for('static', filename='js/mobile.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/websocket.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/utils.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/settings.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/live.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/overview.js') }}"></script>
    <script defer src="{{ url_for('static', filename='js/main.js') }}"></script>
    <!-- Enhanced UI JavaScript -->
    <script defer src="{{ url_for('static', filename='js/enhanced-ui.js') }}"></script>
  </body>
</html>
