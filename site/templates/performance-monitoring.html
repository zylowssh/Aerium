{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/performance-monitoring.css') }}">

<div class="container">
    <div class="performance-header">
        <h1>üìä Monitoring Performance</h1>
            <p>√âtat du syst√®me en temps r√©el et optimisations recommand√©es</p>
        </div>

        <!-- Real-time Metrics Section -->
        <div class="metrics-grid">
            <div class="metric-card cache-card">
                <h3>Cache</h3>
                <div class="metric-value" id="cache-hit-rate">-- %</div>
                <div class="metric-label">Hit Rate</div>
                <div class="metric-details">
                    <p>Taille: <span id="cache-size">--</span> MB</p>
                    <p>Items: <span id="cache-items">--</span></p>
                </div>
                <div class="status-indicator" id="cache-status"></div>
            </div>

            <div class="metric-card latency-card">
                <h3>Latence API</h3>
                <div class="metric-value" id="latency-p95">-- ms</div>
                <div class="metric-label">P95 (95√®me percentile)</div>
                <div class="metric-details">
                    <p>M√©diane: <span id="latency-median">--</span> ms</p>
                    <p>Requ√™tes/sec: <span id="requests-per-sec">--</span></p>
                </div>
                <div class="status-indicator" id="latency-status"></div>
            </div>

            <div class="metric-card database-card">
                <h3>Base Donn√©es</h3>
                <div class="metric-value" id="db-connections">--</div>
                <div class="metric-label">Connexions actives</div>
                <div class="metric-details">
                    <p>Requ√™tes/sec: <span id="db-queries-per-sec">--</span></p>
                    <p>Lentes (>1s): <span id="slow-queries">--</span></p>
                </div>
                <div class="status-indicator" id="db-status"></div>
            </div>

            <div class="metric-card system-card">
                <h3>Syst√®me</h3>
                <div class="metric-value" id="system-cpu">-- %</div>
                <div class="metric-label">CPU Usage</div>
                <div class="metric-details">
                    <p>M√©moire: <span id="system-memory">--</span> %</p>
                    <p>Disque: <span id="system-disk">--</span> %</p>
                </div>
                <div class="status-indicator" id="system-status"></div>
            </div>
        </div>

        <!-- Tabs Section -->
        <div class="tabs-container">
            <div class="tab-navigation">
                <button class="tab-button active" data-tab="realtime">Temps r√©el</button>
                <button class="tab-button" data-tab="history">Historique</button>
                <button class="tab-button" data-tab="cache">Caching</button>
                <button class="tab-button" data-tab="queries">Requ√™tes</button>
                <button class="tab-button" data-tab="rate-limit">Rate Limiting</button>
                <button class="tab-button" data-tab="alerts">Alertes</button>
            </div>

            <!-- Real-time Tab -->
            <div id="realtime-content" class="tab-content active">
                <h2>√âtat du syst√®me maintenant</h2>
                
                <div class="chart-container">
                    <h3>Latence API (derni√®re heure)</h3>
                    <canvas id="latency-chart"></canvas>
                </div>

                <div class="chart-container">
                    <h3>Requ√™tes par seconde</h3>
                    <canvas id="requests-chart"></canvas>
                </div>

                <div class="status-table">
                    <h3>Services Status</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Service</th>
                                <th>Status</th>
                                <th>Latence</th>
                                <th>Erreurs (24h)</th>
                                <th>Uptime</th>
                            </tr>
                        </thead>
                        <tbody id="services-table">
                            <tr>
                                <td>API REST</td>
                                <td><span class="status-badge success">‚úì En ligne</span></td>
                                <td>45ms</td>
                                <td>0.02%</td>
                                <td>99.98%</td>
                            </tr>
                            <tr>
                                <td>Base Donn√©es</td>
                                <td><span class="status-badge success">‚úì En ligne</span></td>
                                <td>12ms</td>
                                <td>0.01%</td>
                                <td>100%</td>
                            </tr>
                            <tr>
                                <td>Cache (Redis)</td>
                                <td><span class="status-badge success">‚úì En ligne</span></td>
                                <td>2ms</td>
                                <td>0%</td>
                                <td>100%</td>
                            </tr>
                            <tr>
                                <td>WebSocket</td>
                                <td><span class="status-badge success">‚úì En ligne</span></td>
                                <td>8ms</td>
                                <td>0%</td>
                                <td>99.99%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- History Tab -->
            <div id="history-content" class="tab-content">
                <h2>Historique Performance (7 jours)</h2>
                
                <div class="history-controls">
                    <label>P√©riode: 
                        <select id="history-period">
                            <option value="7days">Derniers 7 jours</option>
                            <option value="30days">Derniers 30 jours</option>
                            <option value="90days">Derniers 90 jours</option>
                            <option value="1year">Derni√®re ann√©e</option>
                        </select>
                    </label>
                    <label>M√©trique:
                        <select id="history-metric">
                            <option value="latency">Latence API</option>
                            <option value="requests">Requ√™tes/sec</option>
                            <option value="cache">Cache Hit Rate</option>
                            <option value="errors">Taux d'erreur</option>
                        </select>
                    </label>
                </div>

                <div class="chart-container">
                    <canvas id="history-chart"></canvas>
                </div>

                <div class="history-stats">
                    <h3>Statistiques p√©riode</h3>
                    <div class="stats-grid">
                        <div class="stat">
                            <label>Min</label>
                            <value id="stat-min">--</value>
                        </div>
                        <div class="stat">
                            <label>Moyenne</label>
                            <value id="stat-avg">--</value>
                        </div>
                        <div class="stat">
                            <label>Max</label>
                            <value id="stat-max">--</value>
                        </div>
                        <div class="stat">
                            <label>P95</label>
                            <value id="stat-p95">--</value>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cache Tab -->
            <div id="cache-content" class="tab-content">
                <h2>Configuration et statistiques Cache</h2>

                <div class="cache-controls">
                    <h3>Actions</h3>
                    <button class="btn btn-primary" onclick="clearCache()">Vider tout le cache</button>
                    <button class="btn btn-secondary" onclick="showCacheConfig()">Configuration</button>
                </div>

                <div class="cache-stats-detailed">
                    <h3>Cache en d√©tail</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Type donn√©es</th>
                                <th>Items</th>
                                <th>Taille</th>
                                <th>Hit Rate</th>
                                <th>TTL</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="cache-details-table">
                            <tr>
                                <td>Lectures capteurs</td>
                                <td>5,234</td>
                                <td>85 MB</td>
                                <td>92.3%</td>
                                <td>1 heure</td>
                                <td><button class="btn-action">Invalider</button></td>
                            </tr>
                            <tr>
                                <td>Dashboards</td>
                                <td>342</td>
                                <td>52 MB</td>
                                <td>78.5%</td>
                                <td>30 min</td>
                                <td><button class="btn-action">Invalider</button></td>
                            </tr>
                            <tr>
                                <td>Analytics</td>
                                <td>1,523</td>
                                <td>95 MB</td>
                                <td>65.2%</td>
                                <td>2 heures</td>
                                <td><button class="btn-action">Invalider</button></td>
                            </tr>
                            <tr>
                                <td>Configurations</td>
                                <td>897</td>
                                <td>12 MB</td>
                                <td>99.1%</td>
                                <td>24 heures</td>
                                <td><button class="btn-action">Invalider</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="cache-distribution">
                    <h3>Distribution m√©moire cache</h3>
                    <canvas id="cache-distribution-chart"></canvas>
                </div>
            </div>

            <!-- Queries Tab -->
            <div id="queries-content" class="tab-content">
                <h2>Requ√™tes et optimisation</h2>

                <div class="queries-controls">
                    <label>Filtrer par:
                        <select id="query-filter">
                            <option value="all">Toutes</option>
                            <option value="slow">Lentes (>100ms)</option>
                            <option value="errors">Erreurs</option>
                            <option value="most-called">Plus appel√©es</option>
                        </select>
                    </label>
                </div>

                <div class="queries-table">
                    <h3>Top 10 requ√™tes</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Requ√™te</th>
                                <th>Calls</th>
                                <th>Temps moyen</th>
                                <th>P95</th>
                                <th>Taux erreur</th>
                                <th>Recommendation</th>
                            </tr>
                        </thead>
                        <tbody id="queries-table">
                            <tr>
                                <td>GET /api/readings</td>
                                <td>2,543</td>
                                <td>45ms</td>
                                <td>120ms</td>
                                <td>0.01%</td>
                                <td><span class="recommendation good">‚úì Optimal</span></td>
                            </tr>
                            <tr>
                                <td>POST /api/export</td>
                                <td>156</td>
                                <td>2,340ms</td>
                                <td>3,200ms</td>
                                <td>0.64%</td>
                                <td><span class="recommendation bad">‚ö†Ô∏è √Ä optimiser</span></td>
                            </tr>
                            <tr>
                                <td>GET /api/analytics</td>
                                <td>856</td>
                                <td>520ms</td>
                                <td>1,200ms</td>
                                <td>0.12%</td>
                                <td><span class="recommendation warning">‚ñ≥ Cache ?</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="slow-queries-log">
                    <h3>Journal requ√™tes lentes (> 1 seconde)</h3>
                    <div id="slow-queries-log" class="log-content">
                        <!-- Filled by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Rate Limiting Tab -->
            <div id="rate-limit-content" class="tab-content">
                <h2>Limitation de d√©bit (Rate Limiting)</h2>

                <div class="rate-limit-global">
                    <h3>Limites globales syst√®me</h3>
                    <div class="limit-item">
                        <label>Requ√™tes/heure:</label>
                        <div class="limit-bar">
                            <div class="limit-fill" style="width: 67%"></div>
                        </div>
                        <span>67,430 / 100,000</span>
                    </div>
                    <div class="limit-item">
                        <label>Connexions DB:</label>
                        <div class="limit-bar">
                            <div class="limit-fill" style="width: 23%"></div>
                        </div>
                        <span>23 / 100</span>
                    </div>
                    <div class="limit-item">
                        <label>Load CPU:</label>
                        <div class="limit-bar">
                            <div class="limit-fill" style="width: 32%"></div>
                        </div>
                        <span>32% / 100%</span>
                    </div>
                </div>

                <div class="user-rate-limits">
                    <h3>Utilisateurs proches de limite</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Utilisateur</th>
                                <th>Limit</th>
                                <th>Usage</th>
                                <th>% Utilis√©</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="user-limits-table">
                            <tr>
                                <td>integration@client.com</td>
                                <td>1,000/h</td>
                                <td>987</td>
                                <td><span class="progress-bar high">98.7%</span></td>
                                <td><button class="btn-action">Augmenter</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="rate-limit-config">
                    <h3>Configurer limites</h3>
                    <form id="rate-limit-form">
                        <div class="form-group">
                            <label>Utilisateur:</label>
                            <input type="email" id="limit-user">
                        </div>
                        <div class="form-group">
                            <label>Limite (requ√™tes/heure):</label>
                            <input type="number" id="limit-value" value="1000">
                        </div>
                        <button type="submit" class="btn btn-primary">Appliquer</button>
                    </form>
                </div>
            </div>

            <!-- Alerts Tab -->
            <div id="alerts-content" class="tab-content">
                <h2>Alertes et notifications</h2>

                <div class="alerts-config">
                    <h3>Alertes actuellement actives</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Alerte</th>
                                <th>Seuil</th>
                                <th>Valeur actuelle</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Latence P95 > 200ms</td>
                                <td>200ms</td>
                                <td>145ms</td>
                                <td><span class="status-badge success">‚úì OK</span></td>
                                <td><button class="btn-action">√âditer</button></td>
                            </tr>
                            <tr>
                                <td>Cache hit rate < 80%</td>
                                <td>80%</td>
                                <td>87.5%</td>
                                <td><span class="status-badge success">‚úì OK</span></td>
                                <td><button class="btn-action">√âditer</button></td>
                            </tr>
                            <tr>
                                <td>Taux erreur > 1%</td>
                                <td>1%</td>
                                <td>0.02%</td>
                                <td><span class="status-badge success">‚úì OK</span></td>
                                <td><button class="btn-action">√âditer</button></td>
                            </tr>
                            <tr>
                                <td>CPU > 85%</td>
                                <td>85%</td>
                                <td>32%</td>
                                <td><span class="status-badge success">‚úì OK</span></td>
                                <td><button class="btn-action">√âditer</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="alert-history">
                    <h3>Historique des alertes (derniers 7 jours)</h3>
                    <div id="alert-history-list">
                        <!-- Filled by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/performance-monitoring.js') }}"></script>
{% endblock %}
