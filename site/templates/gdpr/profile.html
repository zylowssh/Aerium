{% extends "base.html" %}

{% block content %}

<style>
.gdpr-container {
  max-width: 1000px;
  margin: 0 auto;
  padding: 20px;
}

.gdpr-header h1 {
  color: #e5e7eb;
  font-size: 2.2rem;
  font-weight: 700;
  margin-bottom: 8px;
}

.warning-box {
  background: rgba(255, 107, 107, 0.1);
  border: 1px solid rgba(255, 107, 107, 0.3);
  border-radius: 8px;
  padding: 20px;
  margin: 20px 0;
}

.info-box {
  background: rgba(77, 184, 255, 0.1);
  border: 1px solid rgba(77, 184, 255, 0.3);
  border-radius: 8px;
  padding: 20px;
  margin: 20px 0;
}

.success-box {
  background: rgba(61, 217, 143, 0.1);
  border: 1px solid rgba(61, 217, 143, 0.3);
  border-radius: 8px;
  padding: 20px;
  margin: 20px 0;
}

.consent-list {
  display: grid;
  gap: 15px;
  margin-top: 20px;
}

.consent-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(102, 126, 234, 0.2);
  border-radius: 8px;
}

.consent-info h3 {
  color: #e5e7eb;
  font-size: 1.1rem;
  margin-bottom: 8px;
}

.consent-description {
  color: #9ca3af;
  font-size: 0.9rem;
}

.toggle-switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 34px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(255, 107, 107, 0.3);
  transition: 0.4s;
  border-radius: 34px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 26px;
  width: 26px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: 0.4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: #3dd98f;
}

input:checked + .slider:before {
  transform: translateX(26px);
}

.btn-export {
  padding: 14px 28px;
  background: linear-gradient(135deg, #4db8ff, #667eea);
  border: none;
  border-radius: 8px;
  color: white;
  font-weight: 600;
  cursor: pointer;
  font-size: 1rem;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 10px;
}

.btn-export:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(77, 184, 255, 0.3);
}

.btn-delete {
  padding: 14px 28px;
  background: rgba(255, 107, 107, 0.2);
  border: 1px solid rgba(255, 107, 107, 0.4);
  border-radius: 8px;
  color: #ff6b6b;
  font-weight: 600;
  cursor: pointer;
  font-size: 1rem;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 10px;
}

.btn-delete:hover {
  background: rgba(255, 107, 107, 0.3);
  transform: translateY(-2px);
}

.data-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin: 20px 0;
}

.stat-box {
  padding: 20px;
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(102, 126, 234, 0.2);
  border-radius: 8px;
}

.stat-label {
  color: #9ca3af;
  font-size: 0.9rem;
  margin-bottom: 8px;
}

.stat-value {
  color: #e5e7eb;
  font-size: 1.8rem;
  font-weight: 700;
}
</style>

<div class="gdpr-container">
  <div class="gdpr-header">
    <h1>üîí Mes Donn√©es Personnelles (GDPR)</h1>
    <p style="color: #9ca3af;">Gestion de vos donn√©es et droits RGPD</p>
  </div>

  <div class="info-box">
    <h3 style="color: #4db8ff; margin-bottom: 10px;">‚ÑπÔ∏è Vos Droits RGPD</h3>
    <p style="color: #9ca3af; line-height: 1.6;">
      Conform√©ment au R√®glement G√©n√©ral sur la Protection des Donn√©es (RGPD), vous disposez de plusieurs droits concernant vos donn√©es personnelles:
      droit d'acc√®s, de rectification, d'effacement ("droit √† l'oubli"), de portabilit√© et d'opposition.
    </p>
  </div>

  <!-- Data Summary -->
  <div class="card">
    <h2>üìä R√©sum√© de Vos Donn√©es</h2>
    <div class="data-stats">
      <div class="stat-box">
        <div class="stat-label">Lectures CO‚ÇÇ Stock√©es</div>
        <div class="stat-value">{{ data_summary.co2_readings }}</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Anciennet√© du Compte</div>
        <div class="stat-value">{{ data_summary.account_age_days }} <span style="font-size: 0.8rem;">jours</span></div>
      </div>
    </div>
  </div>

  <!-- Data Portability (Export) -->
  <div class="card">
    <h2>üì• Droit √† la Portabilit√© des Donn√©es</h2>
    <p style="color: #9ca3af; margin-bottom: 20px;">
      T√©l√©chargez toutes vos donn√©es personnelles dans un format structur√© et couramment utilis√©.
    </p>
    <button onclick="exportMyData()" class="btn-export">
      <span>üì¶</span> T√©l√©charger Toutes Mes Donn√©es
    </button>
    <div class="info-box" style="margin-top: 20px;">
      <p style="color: #9ca3af; font-size: 0.9rem;">
        L'export comprendra: profil utilisateur, lectures CO‚ÇÇ, param√®tres, historique de connexion, consentements.
        Format: Archive ZIP avec JSON et CSV.
      </p>
    </div>
  </div>

  <!-- Consent Management -->
  <div class="card">
    <h2>‚úÖ Gestion des Consentements</h2>
    <p style="color: #9ca3af; margin-bottom: 20px;">
      G√©rez vos consentements pour le traitement de vos donn√©es personnelles.
    </p>
    
    <div class="consent-list">
      <div class="consent-item">
        <div class="consent-info">
          <h3>Notifications par Email</h3>
          <div class="consent-description">
            Recevoir des notifications par email concernant les alertes CO‚ÇÇ et les mises √† jour syst√®me.
          </div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="consent-email" 
                 {% if consents|selectattr('consent_type', 'equalto', 'email_notifications')|list|first and consents|selectattr('consent_type', 'equalto', 'email_notifications')|list|first.granted %}checked{% endif %}
                 onchange="updateConsent('email_notifications', this.checked)">
          <span class="slider"></span>
        </label>
      </div>

      <div class="consent-item">
        <div class="consent-info">
          <h3>Analytics et Statistiques</h3>
          <div class="consent-description">
            Permettre l'analyse de vos donn√©es d'utilisation pour am√©liorer le service.
          </div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="consent-analytics"
                 {% if consents|selectattr('consent_type', 'equalto', 'analytics')|list|first and consents|selectattr('consent_type', 'equalto', 'analytics')|list|first.granted %}checked{% endif %}
                 onchange="updateConsent('analytics', this.checked)">
          <span class="slider"></span>
        </label>
      </div>

      <div class="consent-item">
        <div class="consent-info">
          <h3>Partage avec √âquipe</h3>
          <div class="consent-description">
            Partager vos donn√©es de qualit√© d'air avec les membres de votre √©quipe.
          </div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="consent-team"
                 {% if consents|selectattr('consent_type', 'equalto', 'team_sharing')|list|first and consents|selectattr('consent_type', 'equalto', 'team_sharing')|list|first.granted %}checked{% endif %}
                 onchange="updateConsent('team_sharing', this.checked)">
          <span class="slider"></span>
        </label>
      </div>
    </div>
  </div>

  <!-- Right to be Forgotten -->
  <div class="card">
    <h2>üóëÔ∏è Droit √† l'Effacement ("Droit √† l'Oubli")</h2>
    <p style="color: #9ca3af; margin-bottom: 20px;">
      Vous pouvez demander la suppression d√©finitive de votre compte et de toutes vos donn√©es personnelles.
    </p>
    
    <div class="warning-box">
      <h3 style="color: #ff6b6b; margin-bottom: 10px;">‚ö†Ô∏è Attention</h3>
      <p style="color: #9ca3af; line-height: 1.6;">
        Cette action est <strong>irr√©versible</strong>. Toutes vos donn√©es seront d√©finitivement supprim√©es apr√®s un d√©lai de 30 jours.
        Vous pouvez annuler votre demande pendant ce d√©lai.
      </p>
    </div>

    <button onclick="requestDeletion()" class="btn-delete">
      <span>üóëÔ∏è</span> Demander la Suppression de Mon Compte
    </button>
  </div>

  <!-- Data Retention Info -->
  <div class="card">
    <h2>‚è±Ô∏è Politique de Conservation des Donn√©es</h2>
    <p style="color: #9ca3af; margin-bottom: 15px;">
      Dur√©es de conservation appliqu√©es √† vos donn√©es:
    </p>
    <ul style="color: #9ca3af; line-height: 1.8; margin-left: 20px;">
      <li><strong>Lectures CO‚ÇÇ:</strong> Conserv√©es pendant 365 jours</li>
      <li><strong>Historique de connexion:</strong> Conserv√© pendant 90 jours puis supprim√© automatiquement</li>
      <li><strong>Exports de donn√©es:</strong> Conserv√©s pendant 30 jours puis supprim√©s automatiquement</li>
      <li><strong>Compte utilisateur:</strong> Conserv√© jusqu'√† demande de suppression</li>
    </ul>
  </div>

</div>

<script>
async function exportMyData() {
  if (!confirm('Voulez-vous t√©l√©charger toutes vos donn√©es personnelles?')) {
    return;
  }

  try {
    const response = await fetch('/gdpr/export-my-data', {
      method: 'POST'
    });

    if (response.ok) {
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `gdpr_data_export_${new Date().toISOString().slice(0,10)}.zip`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      alert('‚úÖ Export t√©l√©charg√© avec succ√®s!');
    } else {
      alert('‚ùå Erreur lors de l\'export des donn√©es');
    }
  } catch (error) {
    console.error('Error:', error);
    alert('‚ùå Erreur lors de l\'export des donn√©es');
  }
}

async function updateConsent(consentType, granted) {
  try {
    const response = await fetch(`/gdpr/consent/${consentType}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ granted })
    });

    const result = await response.json();

    if (result.success) {
      console.log(`Consent updated: ${consentType} = ${granted}`);
    } else {
      alert('Erreur lors de la mise √† jour du consentement');
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Erreur lors de la mise √† jour du consentement');
  }
}

async function requestDeletion() {
  const reason = prompt('Pouvez-vous nous indiquer la raison de votre demande de suppression? (optionnel)');
  
  if (reason === null) {
    return; // User cancelled
  }

  const confirmed = confirm(
    '‚ö†Ô∏è ATTENTION: Cette action supprimera d√©finitivement votre compte et toutes vos donn√©es apr√®s 30 jours.\\n\\n' +
    'Vous recevrez une confirmation par email et pourrez annuler pendant cette p√©riode.\\n\\n' +
    'Voulez-vous continuer?'
  );

  if (!confirmed) {
    return;
  }

  try {
    const response = await fetch('/gdpr/request-deletion', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ reason, immediate: false })
    });

    const result = await response.json();

    if (result.success) {
      alert(`‚úÖ Demande de suppression enregistr√©e.\\n\\nVotre compte sera supprim√© le: ${new Date(result.scheduled_date).toLocaleDateString()}`);
      location.reload();
    } else {
      alert('‚ùå ' + (result.error || 'Erreur lors de la demande de suppression'));
    }
  } catch (error) {
    console.error('Error:', error);
    alert('‚ùå Erreur lors de la demande de suppression');
  }
}
</script>

{% endblock %}
