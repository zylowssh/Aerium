{% extends "base.html" %}

{% block title %}Collaboration d'√âquipe{% endblock %}

{% block content %}
<style>
  .page-header {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    padding: 50px 40px;
    border-radius: 16px;
    color: white;
    margin-bottom: 40px;
    box-shadow: 0 8px 32px rgba(250, 112, 154, 0.4);
    text-align: center;
  }

  .page-header h1 {
    margin: 0 0 15px 0;
    font-size: 2.8em;
    font-weight: 700;
    letter-spacing: -0.5px;
  }

  .page-header p {
    margin: 0;
    opacity: 0.95;
    font-size: 1.15em;
    font-weight: 300;
  }

  .back-link {
    display: inline-block;
    margin-bottom: 20px;
    color: rgba(255, 255, 255, 0.9);
    text-decoration: none;
    transition: all 0.3s ease;
    font-size: 0.95em;
  }

  .back-link:hover {
    opacity: 0.7;
    transform: translateX(-5px);
  }

  .collaboration-container {
    background: var(--bg);
    min-height: 100vh;
    padding: 2rem;
  }

  .tabs {
    display: flex;
    gap: 0;
    margin-bottom: 2rem;
    border-bottom: 2px solid rgba(102, 126, 234, 0.2);
    overflow-x: auto;
  }

  .tab-button {
    background: transparent;
    border: none;
    color: var(--muted);
    padding: 1rem 1.5rem;
    font-size: 1rem;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.3s ease;
    font-weight: 500;
    white-space: nowrap;
  }

  .tab-button:hover {
    color: var(--accent);
  }

  .tab-button.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
    animation: fadeIn 0.3s ease-in;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .stat-card {
    background: var(--card);
    padding: 1.5rem;
    border-radius: 12px;
    border: 1px solid rgba(102, 126, 234, 0.3);
  }

  .stat-label {
    color: var(--muted);
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
  }

  .stat-value {
    color: var(--text);
    font-size: 2rem;
    font-weight: 700;
  }

  .section {
    background: var(--card);
    padding: 2rem;
    border-radius: 12px;
    border: 1px solid rgba(102, 126, 234, 0.3);
    margin-bottom: 2rem;
  }

  .section-title {
    color: var(--text);
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
  }

  .input-group {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .input-field {
    flex: 1;
    min-width: 150px;
    background: var(--bg);
    border: 1px solid rgba(102, 126, 234, 0.3);
    padding: 0.75rem;
    border-radius: 8px;
    color: var(--text);
    font-size: 1rem;
  }

  .input-field::placeholder {
    color: var(--muted);
  }

  .btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    font-size: 1rem;
  }

  .btn-primary {
    background: var(--accent);
    color: white;
  }

  .btn-primary:hover {
    background: var(--accent-alt);
    transform: translateY(-2px);
  }

  .btn-secondary {
    background: rgba(102, 126, 234, 0.2);
    color: var(--accent);
    border: 1px solid var(--accent);
  }

  .btn-secondary:hover {
    background: rgba(102, 126, 234, 0.3);
  }

  .team-item {
    background: var(--bg);
    padding: 1.5rem;
    border-radius: 8px;
    border: 1px solid rgba(102, 126, 234, 0.3);
    margin-bottom: 1rem;
  }

  .team-name {
    color: var(--text);
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .team-meta {
    color: var(--muted);
    font-size: 0.9rem;
    margin-bottom: 1rem;
  }

  .member-item {
    background: var(--bg);
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid rgba(102, 126, 234, 0.2);
  }

  .member-info {
    flex: 1;
  }

  .member-name {
    color: var(--text);
    font-weight: 600;
  }

  .member-role {
    color: var(--muted);
    font-size: 0.9rem;
  }

  .member-actions {
    display: flex;
    gap: 0.5rem;
  }

  .btn-icon {
    background: rgba(102, 126, 234, 0.1);
    border: none;
    color: var(--accent);
    width: 36px;
    height: 36px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1.2rem;
    transition: all 0.3s ease;
  }

  .btn-icon:hover {
    background: rgba(102, 126, 234, 0.3);
  }

  .share-item {
    background: var(--bg);
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid rgba(102, 126, 234, 0.3);
    margin-bottom: 1rem;
  }

  .share-title {
    color: var(--text);
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .share-link {
    background: var(--bg);
    border: 1px solid rgba(102, 126, 234, 0.3);
    padding: 0.5rem 1rem;
    border-radius: 6px;
    color: var(--accent);
    font-size: 0.9rem;
    word-break: break-all;
  }

  .activity-item {
    background: var(--bg);
    padding: 1rem;
    border-left: 4px solid var(--accent);
    border-radius: 6px;
    margin-bottom: 1rem;
  }

  .activity-time {
    color: var(--muted);
    font-size: 0.85rem;
  }

  .activity-text {
    color: var(--text);
    margin-top: 0.5rem;
  }

  .comment-item {
    background: var(--bg);
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    border: 1px solid rgba(102, 126, 234, 0.2);
  }

  .comment-author {
    color: var(--accent);
    font-weight: 600;
    font-size: 0.9rem;
  }

  .comment-time {
    color: var(--muted);
    font-size: 0.85rem;
    margin-left: 1rem;
  }

  .comment-text {
    color: var(--text);
    margin-top: 0.5rem;
  }

  .empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--muted);
  }

  .empty-state-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }

  .badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    background: rgba(102, 126, 234, 0.2);
    color: var(--accent);
  }

  @media (max-width: 768px) {
    .collab-header h1 {
      font-size: 1.8rem;
    }

    .member-item {
      flex-direction: column;
      align-items: flex-start;
    }

    .member-actions {
      width: 100%;
      margin-top: 1rem;
    }
  }
</style>

<div class="page-header">
  <a href="/" class="back-link">‚Üê Retour √† l'accueil</a>
  <h1>üë• Collaboration d'√âquipe</h1>
  <p>G√©rez vos √©quipes, partagez et collaborez</p>
</div>

<div class="collaboration-container">
  <!-- Tabs Navigation -->
  <div class="tabs">
    <button class="tab-button active" onclick="switchTab('teams')">üè¢ √âquipes</button>
    <button class="tab-button" onclick="switchTab('members')">üë§ Membres</button>
    <button class="tab-button" onclick="switchTab('sharing')">üîó Partage</button>
    <button class="tab-button" onclick="switchTab('activity')">üìã Activit√©</button>
    <button class="tab-button" onclick="switchTab('comments')">üí¨ Commentaires</button>
  </div>

  <!-- Stats -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">√âquipes actives</div>
      <div class="stat-value" id="statsTeams">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Membres totaux</div>
      <div class="stat-value" id="statsMembers">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Partages actifs</div>
      <div class="stat-value" id="statsShares">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Derni√®re activit√©</div>
      <div class="stat-value" id="statsActivity">--</div>
    </div>
  </div>

  <!-- Tab: Teams -->
  <div id="teams" class="tab-content active">
    <div class="section">
      <div class="section-title">Cr√©er une √©quipe</div>
      
      <div class="input-group">
        <input type="text" id="teamName" class="input-field" placeholder="Nom de l'√©quipe">
        <input type="text" id="teamDescription" class="input-field" placeholder="Description">
        <button class="btn btn-primary" onclick="createTeam()">‚ûï Cr√©er</button>
      </div>
    </div>

    <div class="section">
      <div class="section-title">Vos √©quipes</div>
      <div id="teamsList"></div>
      <div id="noTeams" class="empty-state">
        <div class="empty-state-icon">üè¢</div>
        <p>Aucune √©quipe disponible</p>
      </div>
    </div>
  </div>

  <!-- Tab: Members -->
  <div id="members" class="tab-content">
    <div class="section">
      <div class="section-title">Ajouter un membre</div>
      
      <div class="input-group">
        <select id="memberTeam" class="input-field">
          <option value="">S√©lectionner une √©quipe</option>
        </select>
        <input type="email" id="memberEmail" class="input-field" placeholder="Email">
        <select id="memberRole" class="input-field">
          <option value="viewer">Lecteur</option>
          <option value="editor" selected>√âditeur</option>
          <option value="admin">Admin</option>
        </select>
        <button class="btn btn-primary" onclick="addMember()">‚ûï Ajouter</button>
      </div>
    </div>

    <div class="section">
      <div class="section-title">Membres de l'√©quipe</div>
      <div id="membersList"></div>
      <div id="noMembers" class="empty-state">
        <div class="empty-state-icon">üë§</div>
        <p>Aucun membre disponible</p>
      </div>
    </div>
  </div>

  <!-- Tab: Sharing -->
  <div id="sharing" class="tab-content">
    <div class="section">
      <div class="section-title">Cr√©er un lien de partage</div>
      
      <div class="input-group">
        <select id="shareType" class="input-field">
          <option value="dashboard">Tableau de bord</option>
          <option value="analytics">Analytics</option>
          <option value="report">Rapport</option>
        </select>
        <select id="shareExpiration" class="input-field">
          <option value="24">24 heures</option>
          <option value="7" selected>7 jours</option>
          <option value="30">30 jours</option>
          <option value="never">Sans expiration</option>
        </select>
        <button class="btn btn-primary" onclick="createShare()">üîó G√©n√©rer lien</button>
      </div>
    </div>

    <div class="section">
      <div class="section-title">Liens actifs</div>
      <div id="shareList"></div>
      <div id="noShares" class="empty-state">
        <div class="empty-state-icon">üîó</div>
        <p>Aucun lien partag√©</p>
      </div>
    </div>
  </div>

  <!-- Tab: Activity -->
  <div id="activity" class="tab-content">
    <div class="section">
      <div class="section-title">Activit√© r√©cente</div>
      <div id="activityList"></div>
      <div id="noActivity" class="empty-state">
        <div class="empty-state-icon">üìã</div>
        <p>Aucune activit√© disponible</p>
      </div>
    </div>
  </div>

  <!-- Tab: Comments -->
  <div id="comments" class="tab-content">
    <div class="section">
      <div class="section-title">Ajouter un commentaire</div>
      
      <div class="input-group">
        <textarea id="commentText" class="input-field" placeholder="Votre commentaire..." style="min-height: 100px; flex: 1; min-width: 100%;"></textarea>
      </div>
      <button class="btn btn-primary" onclick="postComment()">üì§ Publier</button>
    </div>

    <div class="section">
      <div class="section-title">Discussion de l'√©quipe</div>
      <div id="commentsList"></div>
      <div id="noComments" class="empty-state">
        <div class="empty-state-icon">üí¨</div>
        <p>Aucun commentaire disponible</p>
      </div>
    </div>
  </div>
</div>

<script>
  // Tab switching
  function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');

    if (tabName === 'teams') loadTeams();
    else if (tabName === 'members') { loadTeams(); loadMembers(); }
    else if (tabName === 'sharing') loadShares();
    else if (tabName === 'activity') loadActivity();
    else if (tabName === 'comments') loadComments();
  }

  // Load initial data
  function loadInitialData() {
    loadStats();
    loadTeams();
  }

  // Load statistics
  function loadStats() {
    fetch('/api/teams')
      .then(r => r.json())
      .then(data => {
        const teams = data.teams || [];
        document.getElementById('statsTeams').textContent = teams.length;
        
        let totalMembers = 0;
        teams.forEach(t => {
          totalMembers += (t.members?.length || 0);
        });
        document.getElementById('statsMembers').textContent = totalMembers;
      })
      .catch(() => {});
  }

  // Load teams
  function loadTeams() {
    fetch('/api/teams')
      .then(r => r.json())
      .then(data => {
        const teams = data.teams || [];
        
        // Update member team dropdown
        let options = '<option value="">S√©lectionner une √©quipe</option>';
        teams.forEach(t => {
          options += `<option value="${t.id}">${t.name}</option>`;
        });
        document.getElementById('memberTeam').innerHTML = options;

        if (teams.length === 0) {
          document.getElementById('teamsList').innerHTML = '';
          document.getElementById('noTeams').style.display = 'block';
          return;
        }

        const html = teams.map(team => `
          <div class="team-item">
            <div class="team-name">${team.name}</div>
            <div class="team-meta">
              ${team.description || 'Pas de description'} ‚Ä¢ ${team.members?.length || 0} membres
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <button class="btn-secondary" onclick="editTeam('${team.id}')">‚úèÔ∏è √âditer</button>
              <button class="btn-secondary" onclick="deleteTeam('${team.id}')">üóëÔ∏è Supprimer</button>
            </div>
          </div>
        `).join('');

        document.getElementById('teamsList').innerHTML = html;
        document.getElementById('noTeams').style.display = 'none';
      })
      .catch(err => {
        console.log('Teams error:', err);
        document.getElementById('noTeams').style.display = 'block';
      });
  }

  // Load members
  function loadMembers() {
    fetch('/api/teams')
      .then(r => r.json())
      .then(data => {
        const teams = data.teams || [];
        let allMembers = [];
        
        teams.forEach(team => {
          (team.members || []).forEach(member => {
            allMembers.push({ ...member, team_name: team.name });
          });
        });

        if (allMembers.length === 0) {
          document.getElementById('membersList').innerHTML = '';
          document.getElementById('noMembers').style.display = 'block';
          return;
        }

        const html = allMembers.map(member => `
          <div class="member-item">
            <div class="member-info">
              <div class="member-name">${member.name || member.email || 'Utilisateur'}</div>
              <div class="member-role">${member.team_name} ‚Ä¢ ${member.role || 'member'}</div>
            </div>
            <div class="member-actions">
              <button class="btn-icon" onclick="editMember('${member.id}')">‚úèÔ∏è</button>
              <button class="btn-icon" onclick="removeMember('${member.id}')">üóëÔ∏è</button>
            </div>
          </div>
        `).join('');

        document.getElementById('membersList').innerHTML = html;
        document.getElementById('noMembers').style.display = 'none';
      })
      .catch(err => {
        console.log('Members error:', err);
        document.getElementById('noMembers').style.display = 'block';
      });
  }

  // Load shares
  function loadShares() {
    fetch('/api/share/links')
      .then(r => r.json())
      .then(data => {
        const shares = data.shares || [];
        
        if (shares.length === 0) {
          document.getElementById('shareList').innerHTML = '';
          document.getElementById('noShares').style.display = 'block';
          document.getElementById('statsShares').textContent = 0;
          return;
        }

        const html = shares.map(share => `
          <div class="share-item">
            <div class="share-title">${share.name || 'Partage'}</div>
            <div class="share-link">${share.link || ''}</div>
            <div style="color: var(--muted); font-size: 0.9rem; margin-top: 0.5rem;">
              Expire: ${share.expiration || 'Jamais'}
            </div>
            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
              <button class="btn-secondary" onclick="copyLink('${share.link}')">üìã Copier</button>
              <button class="btn-secondary" onclick="revokeShare('${share.id}')">üóëÔ∏è R√©voquer</button>
            </div>
          </div>
        `).join('');

        document.getElementById('shareList').innerHTML = html;
        document.getElementById('noShares').style.display = 'none';
        document.getElementById('statsShares').textContent = shares.length;
      })
      .catch(err => {
        console.log('Shares error:', err);
        document.getElementById('noShares').style.display = 'block';
      });
  }

  // Load activity
  function loadActivity() {
    fetch('/api/teams/activity')
      .then(r => r.json())
      .then(data => {
        const activities = data.activity || [];
        
        if (activities.length === 0) {
          document.getElementById('activityList').innerHTML = '';
          document.getElementById('noActivity').style.display = 'block';
          return;
        }

        const html = activities.map(act => `
          <div class="activity-item">
            <div class="activity-time">${act.timestamp || new Date().toLocaleString()}</div>
            <div class="activity-text">${act.action || 'Activit√©'}: ${act.details || ''}</div>
          </div>
        `).join('');

        document.getElementById('activityList').innerHTML = html;
        document.getElementById('noActivity').style.display = 'none';
      })
      .catch(err => {
        console.log('Activity error:', err);
        document.getElementById('noActivity').style.display = 'block';
      });
  }

  // Load comments
  function loadComments() {
    fetch('/api/teams/comments')
      .then(r => r.json())
      .then(data => {
        const comments = data.comments || [];
        
        if (comments.length === 0) {
          document.getElementById('commentsList').innerHTML = '';
          document.getElementById('noComments').style.display = 'block';
          return;
        }

        const html = comments.map(comment => `
          <div class="comment-item">
            <div>
              <span class="comment-author">${comment.author || 'Utilisateur'}</span>
              <span class="comment-time">${comment.timestamp || new Date().toLocaleString()}</span>
            </div>
            <div class="comment-text">${comment.text || ''}</div>
          </div>
        `).join('');

        document.getElementById('commentsList').innerHTML = html;
        document.getElementById('noComments').style.display = 'none';
      })
      .catch(err => {
        console.log('Comments error:', err);
        document.getElementById('noComments').style.display = 'block';
      });
  }

  // Actions
  function createTeam() {
    const name = document.getElementById('teamName').value;
    const description = document.getElementById('teamDescription').value;

    if (!name) {
      alert('Veuillez entrer un nom d\'√©quipe');
      return;
    }

    fetch('/api/teams', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, description })
    })
    .then(r => r.json())
    .then(data => {
      document.getElementById('teamName').value = '';
      document.getElementById('teamDescription').value = '';
      loadTeams();
      alert('√âquipe cr√©√©e avec succ√®s');
    })
    .catch(err => alert('Erreur: ' + err.message));
  }

  function editTeam(id) {
    alert('√âdition de l\'√©quipe ' + id);
  }

  function deleteTeam(id) {
    if (confirm('Supprimer cette √©quipe?')) {
      fetch(`/api/teams/${id}`, { method: 'DELETE' })
        .then(() => loadTeams())
        .catch(err => alert('Erreur: ' + err.message));
    }
  }

  function addMember() {
    const team = document.getElementById('memberTeam').value;
    const email = document.getElementById('memberEmail').value;
    const role = document.getElementById('memberRole').value;

    if (!team || !email) {
      alert('Veuillez s√©lectionner une √©quipe et un email');
      return;
    }

    fetch(`/api/teams/${team}/members`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, role })
    })
    .then(r => r.json())
    .then(data => {
      document.getElementById('memberEmail').value = '';
      loadMembers();
      alert('Membre ajout√© avec succ√®s');
    })
    .catch(err => alert('Erreur: ' + err.message));
  }

  function editMember(id) {
    alert('√âdition du membre ' + id);
  }

  function removeMember(id) {
    if (confirm('Supprimer ce membre?')) {
      fetch(`/api/teams/members/${id}`, { method: 'DELETE' })
        .then(() => loadMembers())
        .catch(err => alert('Erreur: ' + err.message));
    }
  }

  function createShare() {
    const type = document.getElementById('shareType').value;
    const expiration = document.getElementById('shareExpiration').value;

    fetch('/api/share/dashboard', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ type, expiration: expiration === 'never' ? null : parseInt(expiration) })
    })
    .then(r => r.json())
    .then(data => {
      alert('Lien partag√© cr√©√©');
      loadShares();
    })
    .catch(err => alert('Erreur: ' + err.message));
  }

  function copyLink(link) {
    navigator.clipboard.writeText(link);
    alert('Lien copi√©');
  }

  function revokeShare(id) {
    if (confirm('R√©voquer ce lien?')) {
      fetch(`/api/share/link/${id}`, { method: 'DELETE' })
        .then(() => loadShares())
        .catch(err => alert('Erreur: ' + err.message));
    }
  }

  function postComment() {
    const text = document.getElementById('commentText').value;

    if (!text) {
      alert('Veuillez entrer un commentaire');
      return;
    }

    fetch('/api/teams/comments', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text })
    })
    .then(r => r.json())
    .then(data => {
      document.getElementById('commentText').value = '';
      loadComments();
      alert('Commentaire publi√©');
    })
    .catch(err => alert('Erreur: ' + err.message));
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', loadInitialData);
</script>
{% endblock %}
