{% extends "base.html" %} 
{% block content %}

<style>
.page-header {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    padding: 50px 40px;
    border-radius: 16px;
    color: white;
    margin-bottom: 40px;
    box-shadow: 0 8px 32px rgba(250, 112, 154, 0.4);
    text-align: center;
}

.page-header h1 {
    margin: 0 0 15px 0;
    font-size: 2.8em;
    font-weight: 700;
    letter-spacing: -0.5px;
}

.page-header p {
    margin: 0;
    opacity: 0.95;
    font-size: 1.15em;
    font-weight: 300;
}

.back-link {
    display: inline-block;
    margin-bottom: 20px;
    color: rgba(255, 255, 255, 0.9);
    text-decoration: none;
    transition: all 0.3s ease;
    font-size: 0.95em;
}

.back-link:hover {
    opacity: 0.7;
    transform: translateX(-5px);
}
</style>

<div class="page-header">
    <a href="/" class="back-link">‚Üê Retour √† l'accueil</a>
    <h1>üìà Visualisations Avanc√©es</h1>
    <p>Analyses interactives et visualisation de vos donn√©es CO‚ÇÇ</p>
</div>

<section class="card">
  <h2>üìä Tableau de Bord Avanc√©</h2>
  <p class="hint">Visualisations interactives des donn√©es CO‚ÇÇ</p>
</section>

<!-- Data Source Selector -->
<section class="card" style="margin-bottom: 24px;">
  <h3>üîÄ Source des Donn√©es</h3>
  <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 16px;">
    <button id="source-live-btn" class="btn btn-secondary active" data-source="live" style="flex: 1; min-width: 150px;">
      üî¥ Donn√©es en Direct
    </button>
    <button id="source-simulation-btn" class="btn btn-secondary" data-source="simulation" style="flex: 1; min-width: 150px;">
      üéÆ Donn√©es Simul√©es
    </button>
    <button id="source-import-btn" class="btn btn-secondary" data-source="import" style="flex: 1; min-width: 150px;">
      üì• Donn√©es Import√©es
    </button>
  </div>
  <p class="hint" style="margin-top: 12px;" id="source-description">
    üì° Affichage des donn√©es en temps r√©el depuis le capteur
  </p>
  
  <!-- CSV Drag and Drop Zone -->
  <div id="csv-dropzone" style="display: none; margin-top: 20px; padding: 40px; border: 2px dashed rgba(255,255,255,0.3); border-radius: 12px; text-align: center; background: rgba(255,255,255,0.02); transition: all 0.3s;">
    <div style="font-size: 3rem; margin-bottom: 12px;">üìÇ</div>
    <h4 style="margin: 0 0 8px 0; color: var(--text-color);">Glissez-d√©posez votre fichier CSV ici</h4>
    <p style="margin: 0 0 16px 0; color: #aaa; font-size: 0.9rem;">ou cliquez pour parcourir</p>
    <input type="file" id="csv-file-input" accept=".csv" style="display: none;" />
    <button id="browse-csv-btn" class="btn btn-primary" style="padding: 10px 24px;">
      Parcourir les fichiers
    </button>
    <div id="upload-progress" style="display: none; margin-top: 16px;">
      <div style="background: rgba(255,255,255,0.1); height: 6px; border-radius: 3px; overflow: hidden;">
        <div id="upload-progress-bar" style="background: linear-gradient(90deg, #3498db, #2ecc71); height: 100%; width: 0%; transition: width 0.3s;"></div>
      </div>
      <p id="upload-status" style="margin-top: 8px; font-size: 0.85rem; color: #aaa;"></p>
    </div>
  </div>
</section>

<div class="analytics-controls" style="margin-bottom: 24px;">
  <div style="display: flex; gap: 12px; flex-wrap: wrap;">
    <button id="chart-daily-btn" class="btn btn-secondary active" data-chart="daily">üìà Moyennes Quotidiennes</button>
    <button id="chart-comparison-btn" class="btn btn-secondary" data-chart="comparison">üìä Comparaison</button>
    <button id="chart-heatmap-btn" class="btn btn-secondary" data-chart="heatmap">üî• Heatmap</button>
    <button id="chart-hourly-btn" class="btn btn-secondary" data-chart="hourly">‚è±Ô∏è Horaire</button>
  </div>
</div>

<!-- Daily Average Chart -->
<section id="daily-chart-section" class="card" style="display: block;">
  <h3>Moyennes Quotidiennes (30 jours)</h3>
  <canvas id="dailyChart" style="max-height: 400px;"></canvas>
  <div id="daily-stats" style="margin-top: 16px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;"></div>
</section>

<!-- Comparison Chart -->
<section id="comparison-chart-section" class="card" style="display: none;">
  <h3>Comparaison de P√©riodes</h3>
  <div style="margin-bottom: 12px;">
    <label style="font-size: 0.9rem;">
      <input type="radio" name="comparison-type" value="week" checked /> Cette semaine vs semaine derni√®re
      <input type="radio" name="comparison-type" value="month" style="margin-left: 16px;"/> Ce mois vs mois dernier
    </label>
  </div>
  <canvas id="comparisonChart" style="max-height: 400px;"></canvas>
  <div id="comparison-stats" style="margin-top: 16px; display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;"></div>
</section>

<!-- Heatmap Chart -->
<section id="heatmap-chart-section" class="card" style="display: none;">
  <h3>Heatmap Horaire (7 derniers jours)</h3>
  <canvas id="heatmapChart" style="max-height: 400px;"></canvas>
  <p class="hint" style="margin-top: 12px;">Les couleurs repr√©sentent les niveaux de CO‚ÇÇ par heure du jour</p>
</section>

<!-- Hourly Chart -->
<section id="hourly-chart-section" class="card" style="display: none;">
  <h3>Tendances Horaires (7 jours)</h3>
  <canvas id="hourlyChart" style="max-height: 400px;"></canvas>
  <div id="hourly-stats" style="margin-top: 16px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;"></div>
</section>

<!-- Heatmap 7x24h Section -->
<section class="card">
  <h3>üî• Carte Thermique 7√ó24h</h3>
  <p class="hint">Visualisez les mod√®les de CO‚ÇÇ dans les jours de la semaine et les heures de la journ√©e</p>
  
  <div style="margin: 20px 0;">
    <button onclick="load7x24Heatmap()" class="btn btn-primary">G√©n√©rer la Carte Thermique</button>
  </div>

  <div id="heatmap-7x24-container" style="min-height: 200px;">
    <div style="text-align: center; padding: 40px; color: #9ca3af;">Cliquez sur "G√©n√©rer" pour charger les donn√©es</div>
  </div>
</section>

<!-- Correlation Analysis Section -->
<section class="card">
  <h3>üìä Analyse de Corr√©lation</h3>
  <p class="hint">D√©couvrez les relations entre les niveaux de CO‚ÇÇ et d'autres variables</p>
  
  <div style="margin: 20px 0;">
    <button onclick="loadCorrelationAnalysis()" class="btn btn-primary">Charger les Corr√©lations</button>
  </div>

  <div id="correlation-container" style="min-height: 200px;">
    <div style="text-align: center; padding: 40px; color: #9ca3af;">Cliquez sur "Charger" pour analyser les corr√©lations</div>
  </div>
</section>

<!-- CSV Import Section -->
<section class="card" id="csv-import-section" style="display: none;">
  <h3>üì• Importer des Donn√©es CO‚ÇÇ</h3>
  <p class="hint">Chargez un fichier CSV avec les colonnes: timestamp, ppm</p>
  
  <style>
    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: block;
    }
    
    .file-input-wrapper input[type="file"] {
      position: absolute;
      left: -9999px;
      opacity: 0;
    }
    
    .file-input-label {
      display: block;
      padding: 24px 20px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.08) 100%);
      border: 2px dashed var(--accent);
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      color: var(--text);
    }
    
    .file-input-label:hover {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.25) 0%, rgba(118, 75, 162, 0.15) 100%);
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    }
    
    .file-input-label.drag-over {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.35) 0%, rgba(118, 75, 162, 0.25) 100%);
      border-color: #667eea;
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.25);
      transform: scale(1.01);
    }
    
    .file-input-icon {
      display: block;
      font-size: 2rem;
      margin-bottom: 8px;
      transition: all 0.3s ease;
    }
    
    .file-input-label.drag-over .file-input-icon {
      transform: scale(1.2);
      animation: bounce 0.6s ease-in-out infinite;
    }
    
    @keyframes bounce {
      0%, 100% { transform: scale(1.2) translateY(0); }
      50% { transform: scale(1.2) translateY(-8px); }
    }
    
    .file-input-text {
      display: block;
      font-size: 0.95rem;
      margin-bottom: 4px;
    }
    
    .file-input-hint {
      display: block;
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 4px;
    }
    
    .file-name-display {
      display: none;
      font-size: 0.9rem;
      color: var(--accent);
      margin-top: 8px;
      font-weight: 600;
    }
  </style>

  <div style="margin-bottom: 16px;" id="dropZone">
    <label class="file-input-wrapper">
      <input 
        type="file" 
        id="csv_import_file" 
        accept=".csv"
        onchange="updateFileName(this)"
      />
      <div class="file-input-label" id="fileInputLabel">
        <span class="file-input-icon">üìÅ</span>
        <span class="file-input-text">Cliquez pour choisir un fichier</span>
        <span class="file-input-hint">ou d√©posez-le ici</span>
        <div class="file-name-display" id="fileName"></div>
      </div>
    </label>
  </div>
  
  <button 
    onclick="importCSV()"
    style="
      width: 100%;
      padding: 14px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      font-size: 1rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    "
    onmouseover="this.style.boxShadow='0 8px 24px rgba(102, 126, 234, 0.45)'; this.style.transform='translateY(-3px)'"
    onmouseout="this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.3)'; this.style.transform='translateY(0)'"
    onmousedown="this.style.transform='translateY(-1px)'"
  >
    ‚¨ÜÔ∏è Charger le fichier CSV
  </button>
  
  <div id="csv_import_result" style="
    font-size: 0.85rem; 
    color: #9ca3af;
    margin-top: 12px;
    padding: 12px;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 6px;
    display: none;
    white-space: pre-wrap;
  "></div>
</section>

<script>
let dailyChartInstance = null;
let comparisonChartInstance = null;
let heatmapChartInstance = null;
let hourlyChartInstance = null;

// Data source tracking
let currentDataSource = 'live'; // 'live', 'simulation', or 'import'

// Chart colors
const colors = {
  good: '#3dd98f',
  warning: '#f9c74f',
  critical: '#ef5350',
  primary: '#4db8ff',
  accent: '#a78bfa'
};

// Get API endpoint based on data source
function getApiEndpoint(endpoint) {
  // Add source parameter to endpoint
  const separator = endpoint.includes('?') ? '&' : '?';
  return `${endpoint}${separator}source=${currentDataSource}`;
}

async function loadDailyChart() {
  try {
    const response = await fetch(getApiEndpoint('/api/analytics/daily-comparison'));
    const data = await response.json();
    
    // Check if data is empty
    if (!data.data || data.data.length === 0) {
      const sourceNames = {
        'live': 'en temps r√©el',
        'simulation': 'de simulation',
        'import': 'import√©es'
      };
      const sourceName = sourceNames[currentDataSource] || currentDataSource;
      document.getElementById('daily-stats').innerHTML = `
        <div style="padding: 20px; text-align: center; color: var(--muted); grid-column: 1/-1;">
          <div style="font-size: 2rem; margin-bottom: 8px;">üìÑ</div>
          <div style="font-size: 1rem;">Aucune donn√©e ${sourceName} disponible</div>
        </div>
      `;
      // Keep existing chart; just return
      return;
    }
    
    const ctx = document.getElementById('dailyChart').getContext('2d');
    
    if (dailyChartInstance) dailyChartInstance.destroy();
    
    dailyChartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.data.map(d => d.date),
        datasets: [
          {
            label: 'Moyenne (ppm)',
            data: data.data.map(d => d.avg_ppm),
            borderColor: colors.primary,
            backgroundColor: `${colors.primary}20`,
            borderWidth: 2,
            tension: 0.4,
            fill: true,
            pointRadius: 4,
            pointHoverRadius: 6,
            pointBackgroundColor: colors.primary
          },
          {
            label: 'Min (ppm)',
            data: data.data.map(d => d.min_ppm),
            borderColor: colors.good,
            borderDash: [5, 5],
            borderWidth: 1,
            pointRadius: 2
          },
          {
            label: 'Max (ppm)',
            data: data.data.map(d => d.max_ppm),
            borderColor: colors.critical,
            borderDash: [5, 5],
            borderWidth: 1,
            pointRadius: 2
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            labels: { color: 'var(--text)', font: { size: 12, weight: 600 } }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.9)',
            titleColor: 'var(--text)',
            bodyColor: 'var(--text)',
            padding: 12,
            cornerRadius: 8,
            titleFont: { weight: 'bold', size: 13 },
            bodyFont: { size: 12 },
            borderColor: 'rgba(102, 126, 234, 0.3)',
            borderWidth: 1
          }
        },
        scales: {
          y: {
            beginAtZero: false,
            ticks: { color: 'var(--text)', font: { size: 11, weight: 500 } },
            grid: { color: 'rgba(255, 255, 255, 0.08)' }
          },
          x: {
            ticks: { color: 'var(--text)', font: { size: 11, weight: 500 } },
            grid: { color: 'rgba(255, 255, 255, 0.04)' }
          }
        }
      }
    });
    
    // Display stats
    const avgs = data.data.map(d => d.avg_ppm).filter(v => v !== null && v !== undefined);
    if (avgs.length > 0) {
      const avgValue = (avgs.reduce((a, b) => a + b, 0) / avgs.length).toFixed(0);
      const minValue = Math.min(...avgs).toFixed(0);
      const maxValue = Math.max(...avgs).toFixed(0);
      
      const statsHtml = `
        <div style="padding: 12px; background: rgba(61, 217, 143, 0.1); border-radius: 8px; border-left: 4px solid var(--good);">
          <div style="font-size: 0.85rem; color: var(--muted);">Moyenne</div>
          <div style="font-weight: 600; font-size: 1.3rem;">${avgValue} ppm</div>
        </div>
        <div style="padding: 12px; background: rgba(249, 199, 79, 0.1); border-radius: 8px; border-left: 4px solid var(--medium);">
          <div style="font-size: 0.85rem; color: var(--muted);">Min</div>
          <div style="font-weight: 600; font-size: 1.3rem;">${minValue} ppm</div>
        </div>
        <div style="padding: 12px; background: rgba(239, 83, 80, 0.1); border-radius: 8px; border-left: 4px solid var(--bad);">
          <div style="font-size: 0.85rem; color: var(--muted);">Max</div>
          <div style="font-weight: 600; font-size: 1.3rem;">${maxValue} ppm</div>
        </div>
      `;
      document.getElementById('daily-stats').innerHTML = statsHtml;
    } else {
      document.getElementById('daily-stats').innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--muted);">Aucune statistique disponible</div>';
    }
  } catch (error) {
    console.error('Error loading daily chart:', error);
  }
}

async function loadComparisonChart(type = 'week') {
  try {
    const response = await fetch(getApiEndpoint(`/api/analytics/compare-periods?type=${type}`));
    const data = await response.json();
    
    // Handle empty data
    const currentData = {
      avg: data.current?.avg || 0,
      min: data.current?.min || 0,
      max: data.current?.max || 0,
      count: data.current?.count || 0
    };
    const previousData = {
      avg: data.previous?.avg || 0,
      min: data.previous?.min || 0,
      max: data.previous?.max || 0,
      count: data.previous?.count || 0
    };
    
    const ctx = document.getElementById('comparisonChart').getContext('2d');
    
    if (comparisonChartInstance) comparisonChartInstance.destroy();
    
    const periods = type === 'week' ? ['Semaine actuelle', 'Semaine derni√®re'] : ['Mois actuel', 'Mois dernier'];
    
    comparisonChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: periods,
        datasets: [
          {
            label: 'Moyenne (ppm)',
            data: [currentData.avg, previousData.avg],
            backgroundColor: [colors.primary, `${colors.primary}60`],
            borderColor: colors.primary,
            borderWidth: 1
          },
          {
            label: 'Min (ppm)',
            data: [currentData.min, previousData.min],
            backgroundColor: [colors.good, `${colors.good}60`],
            borderColor: colors.good,
            borderWidth: 1
          },
          {
            label: 'Max (ppm)',
            data: [currentData.max, previousData.max],
            backgroundColor: [colors.critical, `${colors.critical}60`],
            borderColor: colors.critical,
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            labels: { color: 'var(--text)', font: { size: 12, weight: 600 } }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.9)',
            titleColor: 'var(--text)',
            bodyColor: 'var(--text)',
            padding: 12,
            cornerRadius: 8,
            titleFont: { weight: 'bold', size: 13 },
            bodyFont: { size: 12 },
            borderColor: 'rgba(102, 126, 234, 0.3)',
            borderWidth: 1
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { color: 'var(--text)', font: { size: 11, weight: 500 } },
            grid: { color: 'rgba(255, 255, 255, 0.08)' }
          },
          x: {
            ticks: { color: 'var(--text)', font: { size: 11, weight: 500 } },
            grid: { display: false }
          }
        }
      }
    });
    
    // Display stats
    const diffAvg = data.differences?.avg_percent || 0;
    const diffMin = data.differences?.min_percent || 0;
    const diffMax = data.differences?.max_percent || 0;
    
    // Check if there's any data
    if (currentData.count === 0 && previousData.count === 0) {
      const sourceNames = {
        'live': 'en temps r√©el',
        'simulation': 'de simulation',
        'import': 'import√©es'
      };
      const sourceName = sourceNames[currentDataSource] || currentDataSource;
      document.getElementById('comparison-stats').innerHTML = `
        <div style="padding: 20px; text-align: center; color: var(--muted); grid-column: 1/-1;">
          <div style="font-size: 2rem; margin-bottom: 8px;">üìÑ</div>
          <div style="font-size: 1rem;">Aucune donn√©e ${sourceName} disponible pour la comparaison</div>
        </div>
      `;
      return;
    }
    
    const arrow = (val) => val > 0 ? 'üìà' : val < 0 ? 'üìâ' : '‚û°Ô∏è';
    const color = (val) => val > 0 ? 'var(--bad)' : 'var(--good)';
    
    const statsHtml = `
      <div style="padding: 12px; background: rgba(74, 184, 255, 0.1); border-radius: 8px; border-left: 4px solid var(--accent);">
        <div style="font-size: 0.85rem; color: var(--muted);">Moyenne ${arrow(diffAvg)}</div>
        <div style="font-weight: 600; font-size: 1.3rem; color: ${color(diffAvg)};">${Math.abs(diffAvg).toFixed(1)}%</div>
      </div>
      <div style="padding: 12px; background: rgba(61, 217, 143, 0.1); border-radius: 8px; border-left: 4px solid var(--good);">
        <div style="font-size: 0.85rem; color: var(--muted);">Min ${arrow(diffMin)}</div>
        <div style="font-weight: 600; font-size: 1.3rem; color: ${color(diffMin)};">${Math.abs(diffMin).toFixed(1)}%</div>
      </div>
      <div style="padding: 12px; background: rgba(239, 83, 80, 0.1); border-radius: 8px; border-left: 4px solid var(--bad);">
        <div style="font-size: 0.85rem; color: var(--muted);">Max ${arrow(diffMax)}</div>
        <div style="font-weight: 600; font-size: 1.3rem; color: ${color(diffMax)};">${Math.abs(diffMax).toFixed(1)}%</div>
      </div>
    `;
    document.getElementById('comparison-stats').innerHTML = statsHtml;
  } catch (error) {
    console.error('Error loading comparison chart:', error);
  }
}

async function loadHeatmapChart() {
  try {
    const response = await fetch(getApiEndpoint('/api/analytics/trend'));
    const data = await response.json();
    
    // Check if data is empty
    if (!data.data || data.data.length === 0) {
      return;
    }
    
    // Group by hour of day
    const heatmapData = {};
    for (let h = 0; h < 24; h++) {
      heatmapData[h] = [];
    }
    
    data.data.forEach(d => {
      const date = new Date(d.hour);
      const hour = date.getHours();
      heatmapData[hour].push(d.avg_ppm || 0);
    });
    
    // Calculate average for each hour
    const hourlyAvgs = Object.keys(heatmapData).map(h => {
      const values = heatmapData[h];
      return values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : 0;
    });
    
    const ctx = document.getElementById('heatmapChart').getContext('2d');
    
    if (heatmapChartInstance) heatmapChartInstance.destroy();
    
    heatmapChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Array.from({length: 24}, (_, i) => `${i}h`),
        datasets: [{
          label: 'CO‚ÇÇ moyen (ppm)',
          data: hourlyAvgs,
          backgroundColor: hourlyAvgs.map(val => {
            if (val <= 800) return colors.good;
            if (val <= 1000) return colors.warning;
            if (val <= 1200) return '#ff9800';
            return colors.critical;
          }),
          borderColor: 'rgba(255, 255, 255, 0.2)',
          borderWidth: 1
        }]
      },
      options: {
        indexAxis: 'x',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.9)',
            titleColor: 'var(--text)',
            bodyColor: 'var(--text)',
            padding: 12,
            cornerRadius: 8,
            borderColor: 'rgba(102, 126, 234, 0.3)',
            borderWidth: 1
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { color: 'var(--text)', font: { size: 11, weight: 500 } },
            grid: { color: 'rgba(255, 255, 255, 0.08)' }
          },
          x: {
            ticks: { color: 'var(--text)', font: { size: 11, weight: 500 } },
            grid: { display: false }
          }
        }
      }
    });
  } catch (error) {
    console.error('Error loading heatmap:', error);
  }
}

async function loadHourlyChart() {
  try {
    const response = await fetch(getApiEndpoint('/api/analytics/trend'));
    const data = await response.json();
    
    // Check if data is empty
    if (!data.data || data.data.length === 0) {
      return;
    }
    
    const ctx = document.getElementById('hourlyChart').getContext('2d');
    
    if (hourlyChartInstance) hourlyChartInstance.destroy();
    
    hourlyChartInstance = new Chart(ctx, {
      type: 'area',
      data: {
        labels: data.data.slice(0, 168).map(d => d.hour).reverse(),
        datasets: [{
          label: 'CO‚ÇÇ (ppm)',
          data: data.data.slice(0, 168).map(d => d.avg_ppm).reverse(),
          borderColor: colors.accent,
          backgroundColor: `${colors.accent}30`,
          borderWidth: 2,
          fill: true,
          tension: 0.4,
          pointRadius: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true, labels: { color: 'var(--text)', font: { size: 12, weight: 600 } } },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.9)',
            titleColor: 'var(--text)',
            bodyColor: 'var(--text)',
            padding: 12,
            cornerRadius: 8,
            titleFont: { weight: 'bold', size: 13 },
            bodyFont: { size: 12 },
            borderColor: 'rgba(102, 126, 234, 0.3)',
            borderWidth: 1
          }
        },
        scales: {
          y: {
            beginAtZero: false,
            ticks: { color: 'var(--text)', font: { size: 11, weight: 500 } },
            grid: { color: 'rgba(255, 255, 255, 0.08)' }
          },
          x: {
            ticks: { color: 'var(--text)', font: { size: 11, weight: 500 } },
            grid: { color: 'rgba(255, 255, 255, 0.04)' }
          }
        }
      }
    });
  } catch (error) {
    console.error('Error loading hourly chart:', error);
  }
}

// Tab switching
document.querySelectorAll('[data-chart]').forEach(btn => {
  btn.addEventListener('click', function() {
    const chart = this.getAttribute('data-chart');
    
    // Hide all sections
    document.querySelectorAll('[id$="-chart-section"]').forEach(s => s.style.display = 'none');
    document.querySelectorAll('[data-chart]').forEach(b => b.classList.remove('active'));
    
    // Show selected
    this.classList.add('active');
    document.getElementById(`${chart}-chart-section`).style.display = 'block';
    
    // Load chart
    if (chart === 'daily') loadDailyChart();
    else if (chart === 'comparison') loadComparisonChart();
    else if (chart === 'heatmap') loadHeatmapChart();
    else if (chart === 'hourly') loadHourlyChart();
  });
});

// Comparison period radio buttons
document.querySelectorAll('input[name="comparison-type"]').forEach(radio => {
  radio.addEventListener('change', (e) => {
    loadComparisonChart(e.target.value);
  });
});

// Data source switching
document.querySelectorAll('[data-source]').forEach(btn => {
  btn.addEventListener('click', function() {
    const source = this.getAttribute('data-source');
    
    // Update active state
    document.querySelectorAll('[data-source]').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    
    // Update current data source
    currentDataSource = source;
    
    // Update description
    const descriptions = {
      'live': 'üì° Affichage des donn√©es en temps r√©el depuis le capteur',
      'simulation': 'üéÆ Affichage des donn√©es de simulation pour les tests',
      'import': 'üì• Affichage des donn√©es import√©es depuis les fichiers CSV'
    };
    document.getElementById('source-description').textContent = descriptions[source];
    
    // Show/hide CSV import section based on data source
    const csvImportSection = document.getElementById('csv-import-section');
    if (source === 'import') {
      csvImportSection.style.display = 'block';
    } else {
      csvImportSection.style.display = 'none';
    }
    
    // Reload current chart with new data source
    const activeChart = document.querySelector('[data-chart].active');
    if (activeChart) {
      const chartType = activeChart.getAttribute('data-chart');
      if (chartType === 'daily') loadDailyChart();
      else if (chartType === 'comparison') loadComparisonChart();
      else if (chartType === 'heatmap') loadHeatmapChart();
      else if (chartType === 'hourly') loadHourlyChart();
    }
  });
});

// Load initial chart
loadDailyChart();

// Setup drag and drop
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('csv_import_file');
const fileInputLabel = document.getElementById('fileInputLabel');

// Prevent default drag behaviors
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
  dropZone.addEventListener(eventName, preventDefaults, false);
  document.body.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
  e.preventDefault();
  e.stopPropagation();
}

// Highlight drop zone when item is dragged over it
['dragenter', 'dragover'].forEach(eventName => {
  dropZone.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
  dropZone.addEventListener(eventName, unhighlight, false);
});

function highlight(e) {
  fileInputLabel.classList.add('drag-over');
}

function unhighlight(e) {
  fileInputLabel.classList.remove('drag-over');
}

// Handle dropped files
dropZone.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
  const dt = e.dataTransfer;
  const files = dt.files;
  
  if (files.length > 0) {
    const file = files[0];
    if (file.name.endsWith('.csv')) {
      fileInput.files = files;
      updateFileName(fileInput);
    } else {
      const resultDiv = document.getElementById('csv_import_result');
      resultDiv.style.display = 'block';
      resultDiv.style.color = '#ff6b6b';
      resultDiv.textContent = '‚ö†Ô∏è Veuillez d√©poser un fichier CSV valide';
    }
  }
}

// Update file name display
function updateFileName(input) {
  const fileNameDisplay = document.getElementById('fileName');
  if (input.files && input.files[0]) {
    fileNameDisplay.textContent = `‚úì ${input.files[0].name}`;
    fileNameDisplay.style.display = 'block';
  } else {
    fileNameDisplay.style.display = 'none';
  }
}

// Heatmap 7x24h Function
function load7x24Heatmap() {
    const container = document.getElementById('heatmap-7x24-container');
    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;">G√©n√©ration de la carte thermique...</div>';
    
    fetch('/api/visualization/heatmap')
        .then(r => r.json())
        .then(data => {
            if (data.success && data.heatmap) {
                let html = '<div style="overflow-x: auto;">';
                html += '<div style="display: flex; gap: 25px; margin-bottom: 20px; flex-wrap: wrap;">';
                html += '<span style="display: flex; align-items: center; gap: 8px;"><span style="width: 20px; height: 20px; background: #4ade80; border-radius: 4px;"></span>Bon (400-800)</span>';
                html += '<span style="display: flex; align-items: center; gap: 8px;"><span style="width: 20px; height: 20px; background: #fbbf24; border-radius: 4px;"></span>Moyen (800-1200)</span>';
                html += '<span style="display: flex; align-items: center; gap: 8px;"><span style="width: 20px; height: 20px; background: #f87171; border-radius: 4px;"></span>Mauvais (1200+)</span>';
                html += '</div>';
                html += '<table style="width: 100%; border-collapse: collapse; background: rgba(255,255,255,0.03); border-radius: 8px;">';
                
                const days = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
                html += '<tr><th style="padding: 10px; background: var(--accent); color: white;"></th>';
                days.forEach(day => html += `<th style="padding: 10px; background: var(--accent); color: white;">${day}</th>`);
                html += '</tr>';
                
                for (let hour = 0; hour < 24; hour++) {
                    html += `<tr><td style="padding: 8px; font-weight: 600; background: var(--accent); color: white;">${hour}:00</td>`;
                    for (let day = 0; day < 7; day++) {
                        const value = data.heatmap[hour]?.[day] || 500;
                        const color = value < 800 ? '#4ade80' : value < 1200 ? '#fbbf24' : '#f87171';
                        html += `<td style="padding: 12px; text-align: center; background: ${color}; color: #0b0d12; font-weight: 600; border: 1px solid rgba(0,0,0,0.1); cursor: pointer;" title="${value} ppm">${Math.round(value)}</td>`;
                    }
                    html += '</tr>';
                }
                
                html += '</table></div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #f87171;">Impossible de charger les donn√©es</div>';
            }
        })
        .catch(e => {
            container.innerHTML = `<div style="text-align: center; padding: 40px; color: #f87171;">Erreur: ${e.message}</div>`;
        });
}

// Correlation Analysis Function
function loadCorrelationAnalysis() {
    const container = document.getElementById('correlation-container');
    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;">Analyse des corr√©lations...</div>';
    
    fetch('/api/visualization/correlation')
        .then(r => r.json())
        .then(data => {
            if (data.success && data.correlations) {
                let html = '<div>';
                html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">';
                html += '<thead><tr>';
                html += '<th style="padding: 15px; text-align: left; background: var(--accent); color: white;">Variable</th>';
                html += '<th style="padding: 15px; text-align: center; background: var(--accent); color: white;">Corr√©lation avec CO‚ÇÇ</th>';
                html += '<th style="padding: 15px; text-align: center; background: var(--accent); color: white;">Force</th>';
                html += '</tr></thead><tbody>';
                
                data.correlations.forEach(corr => {
                    const strength = Math.abs(corr.value) > 0.7 ? 'Forte' : Math.abs(corr.value) > 0.4 ? 'Moyenne' : 'Faible';
                    const color = Math.abs(corr.value) > 0.7 ? '#4ade80' : Math.abs(corr.value) > 0.4 ? '#fbbf24' : '#9ca3af';
                    html += `<tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">`;
                    html += `<td style="padding: 15px;">${corr.name}</td>`;
                    html += `<td style="padding: 15px; text-align: center; font-weight: 600;">${corr.value.toFixed(2)}</td>`;
                    html += `<td style="padding: 15px; text-align: center; color: ${color};">${strength}</td>`;
                    html += `</tr>`;
                });
                
                html += '</tbody></table>';
                html += '<div style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: 8px;">';
                html += '<p style="margin: 10px 0; line-height: 1.5;">Les corr√©lations montrent les relations entre les niveaux de CO‚ÇÇ et d\'autres facteurs.</p>';
                html += '<p style="margin: 10px 0; line-height: 1.5;">Une corr√©lation proche de +1 ou -1 indique une forte relation.</p>';
                html += '</div></div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #f87171;">Impossible de charger les corr√©lations</div>';
            }
        })
        .catch(e => {
            container.innerHTML = `<div style="text-align: center; padding: 40px; color: #f87171;">Erreur: ${e.message}</div>`;
        });
}

// CSV Import Function
async function importCSV() {
  const fileInput = document.getElementById('csv_import_file');
  const resultDiv = document.getElementById('csv_import_result');
  const file = fileInput.files[0];
  
  if (!file) {
    resultDiv.style.display = 'block';
    resultDiv.style.color = '#ff6b6b';
    resultDiv.textContent = '‚ö†Ô∏è Veuillez s√©lectionner un fichier CSV';
    return;
  }
  
  const formData = new FormData();
  formData.append('file', file);
  
  try {
    resultDiv.style.display = 'block';
    resultDiv.style.color = '#9ca3af';
    resultDiv.textContent = 'üì§ T√©l√©chargement en cours...';
    
    const response = await fetch('/api/import/csv', {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    
    if (response.ok) {
      resultDiv.style.color = '#3dd98f';
      resultDiv.textContent = `‚úÖ Succ√®s!\n\n` +
        `Lectures import√©es: ${result.imported || result.success || 0}\n` +
        `Lignes ignor√©es: ${result.skipped || 0}\n` +
        `Erreurs: ${result.errors || 0}`;
      
      fileInput.value = '';
      
      // Reload charts after import
      setTimeout(() => {
        loadDailyChart();
        loadComparisonChart('week');
        loadHeatmapChart();
        loadHourlyChart();
      }, 1000);
    } else {
      resultDiv.style.color = '#ff6b6b';
      resultDiv.textContent = `‚ùå Erreur:\n${result.error || result.message || 'Erreur lors du t√©l√©chargement'}`;
    }
  } catch (error) {
    resultDiv.style.display = 'block';
    resultDiv.style.color = '#ff6b6b';
    resultDiv.textContent = `‚ùå Erreur r√©seau:\n${error.message}`;
  }
}
</script>

<!-- CSV Drag and Drop Enhancement -->
<script src="{{ url_for('static', filename='js/csv-dragdrop.js') }}"></script>

{% endblock %}
