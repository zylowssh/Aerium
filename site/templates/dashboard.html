{% extends "base.html" %}

{% block content %}

<!-- Show Admin Dashboard if user is admin -->
{% if is_admin %}

<section class="card">
  <h2>âš™ï¸ Admin Dashboard</h2>
  
  <!-- Statistics Section -->
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <!-- Total Users -->
    <div style="
      background: linear-gradient(135deg, rgba(61, 217, 143, 0.2), rgba(77, 184, 255, 0.1));
      border: 1px solid rgba(61, 217, 143, 0.3);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    ">
      <div style="font-size: 2.5rem; font-weight: 700; color: #3dd98f; margin-bottom: 5px;">{{ admin_stats.total_users }}</div>
      <div style="color: #9ca3af; font-size: 0.9rem;">Utilisateurs Totaux</div>
      <div style="color: #7a8fa6; font-size: 0.85rem; margin-top: 5px;">{{ admin_stats.verified_users }} vÃ©rifiÃ©s</div>
    </div>

    <!-- Admin Count -->
    <div style="
      background: linear-gradient(135deg, rgba(239, 83, 80, 0.2), rgba(255, 107, 107, 0.1));
      border: 1px solid rgba(239, 83, 80, 0.3);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    ">
      <div style="font-size: 2.5rem; font-weight: 700; color: #ff6b6b; margin-bottom: 5px;">{{ admin_stats.admin_count }}</div>
      <div style="color: #9ca3af; font-size: 0.9rem;">Administrateurs</div>
    </div>

    <!-- CO2 Readings -->
    <div style="
      background: linear-gradient(135deg, rgba(77, 184, 255, 0.2), rgba(61, 217, 143, 0.1));
      border: 1px solid rgba(77, 184, 255, 0.3);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    ">
      <div style="font-size: 2.5rem; font-weight: 700; color: #4db8ff; margin-bottom: 5px;">{{ admin_stats.total_readings }}</div>
      <div style="color: #9ca3af; font-size: 0.9rem;">Lectures COâ‚‚</div>
      <div style="color: #7a8fa6; font-size: 0.85rem; margin-top: 5px;">Moyenne: {{ admin_stats.avg_ppm }} ppm</div>
    </div>

    <!-- Recent Logins -->
    <div style="
      background: linear-gradient(135deg, rgba(77, 184, 255, 0.2), rgba(61, 217, 143, 0.1));
      border: 1px solid rgba(77, 184, 255, 0.3);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    ">
      <div style="font-size: 2.5rem; font-weight: 700; color: #4ade80; margin-bottom: 5px;">{{ admin_stats.recent_logins }}</div>
      <div style="color: #9ca3af; font-size: 0.9rem;">Connexions (24h)</div>
    </div>
  </div>

  <!-- User Management Section -->
  <div style="margin-top: 40px; padding-top: 30px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
    <h3 style="margin-bottom: 20px; color: #e5e7eb;">ğŸ‘¥ Gestion des Utilisateurs</h3>
    
    <div style="overflow-x: auto;">
      <table style="width: 100%; color: #e5e7eb; font-size: 0.9rem;">
        <thead>
          <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.2);">
            <th style="text-align: left; padding: 15px 10px; color: #9ca3af; font-weight: 600;">Nom d'utilisateur</th>
            <th style="text-align: left; padding: 15px 10px; color: #9ca3af; font-weight: 600;">Email</th>
            <th style="text-align: center; padding: 15px 10px; color: #9ca3af; font-weight: 600;">VÃ©rifiÃ©e</th>
            <th style="text-align: center; padding: 15px 10px; color: #9ca3af; font-weight: 600;">RÃ´le</th>
            <th style="text-align: center; padding: 15px 10px; color: #9ca3af; font-weight: 600;">CrÃ©Ã©e</th>
            <th style="text-align: center; padding: 15px 10px; color: #9ca3af; font-weight: 600;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in admin_users %}
          <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.05); padding: 10px 0;">
            <td style="padding: 15px 10px;">
              <strong>{{ user.username }}</strong>
            </td>
            <td style="padding: 15px 10px; font-size: 0.85rem; color: #9ca3af;">
              {{ user.email }}
            </td>
            <td style="padding: 15px 10px; text-align: center;">
              {% if user.email_verified %}
              <span style="color: #4ade80;">âœ“</span>
              {% else %}
              <span style="color: #ff6b6b;">âœ—</span>
              {% endif %}
            </td>
            <td style="padding: 15px 10px; text-align: center;">
              {% if user.role == 'admin' %}
              <span style="background: rgba(239, 83, 80, 0.2); color: #ff6b6b; padding: 4px 8px; border-radius: 4px; font-weight: 600;">Admin</span>
              {% else %}
              <span style="background: rgba(61, 217, 143, 0.2); color: #4ade80; padding: 4px 8px; border-radius: 4px;">Utilisateur</span>
              {% endif %}
            </td>
            <td style="padding: 15px 10px; text-align: center; font-size: 0.85rem; color: #9ca3af;">
              {{ user.created_at.split(' ')[0] if user.created_at else 'N/A' }}
            </td>
            <td style="padding: 15px 10px; text-align: center;">
              {% if user.id != session.get('user_id') %}
              <button 
                onclick="toggleRole({{ user.id }}, '{{ user.role }}')"
                style="
                  padding: 6px 12px;
                  background: {% if user.role == 'user' %}rgba(61, 217, 143, 0.2){% else %}rgba(77, 184, 255, 0.2){% endif %};
                  border: 1px solid {% if user.role == 'user' %}rgba(61, 217, 143, 0.3){% else %}rgba(77, 184, 255, 0.3){% endif %};
                  color: {% if user.role == 'user' %}#4ade80{% else %}#4db8ff{% endif %};
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 0.85rem;
                  font-weight: 600;
                  transition: all 0.2s ease;
                "
                onmouseover="this.style.opacity='0.8'"
                onmouseout="this.style.opacity='1'"
              >
                {% if user.role == 'user' %}Faire Admin{% else %}Retirer Admin{% endif %}
              </button>
              {% else %}
              <span style="color: #9ca3af; font-size: 0.85rem;">Vous</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>

<script>
function toggleRole(userId, currentRole) {
  const newRole = currentRole === 'admin' ? 'user' : 'admin';
  const action = newRole === 'admin' ? 'Faire Admin' : 'Retirer Admin';
  
  if (!confirm(`ÃŠtes-vous sÃ»r de vouloir ${action} cet utilisateur?`)) {
    return;
  }
  
  fetch(`/admin/user/${userId}/role/${newRole}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Reload the page to show updated roles
      location.reload();
    } else {
      alert('Erreur: ' + (data.error || 'Impossible de mettre Ã  jour le rÃ´le'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Impossible de mettre Ã  jour le rÃ´le utilisateur');
  });
}
</script>

<!-- Regular User Dashboard -->
{% else %}

<!-- ================= WELCOME SECTION ================= -->
<section class="card">
  <h2>ğŸ‘‹ Bienvenue, {{ user.username }}!</h2>
  
  <!-- Quick Stats Grid -->
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <!-- Today's Average CO2 -->
    <div style="
      background: linear-gradient(135deg, rgba(77, 184, 255, 0.2), rgba(61, 217, 143, 0.1));
      border: 1px solid rgba(77, 184, 255, 0.3);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    ">
      <div style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 10px;">Moyenne COâ‚‚ (Aujourd'hui)</div>
      <div style="font-size: 2.5rem; font-weight: 700; color: #4db8ff; margin-bottom: 5px;">
        {% if today_stats.avg_ppm %}{{ today_stats.avg_ppm|round(0)|int }}{% else %}â€”{% endif %} ppm
      </div>
      <div style="color: #7a8fa6; font-size: 0.85rem;">
        {% if today_stats.total_readings %}{{ today_stats.total_readings }} lectures{% else %}Pas de donnÃ©es{% endif %}
      </div>
    </div>

    <!-- Peak CO2 Today -->
    <div style="
      background: linear-gradient(135deg, rgba(239, 83, 80, 0.2), rgba(255, 107, 107, 0.1));
      border: 1px solid rgba(239, 83, 80, 0.3);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    ">
      <div style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 10px;">Pic COâ‚‚ (Aujourd'hui)</div>
      <div style="font-size: 2.5rem; font-weight: 700; color: #ff6b6b; margin-bottom: 5px;">
        {% if today_stats.max_ppm %}{{ today_stats.max_ppm|round(0)|int }}{% else %}â€”{% endif %} ppm
      </div>
      <div style="color: #7a8fa6; font-size: 0.85rem;">
        {% if today_stats.min_ppm %}Min: {{ today_stats.min_ppm|round(0)|int }} ppm{% else %}N/A{% endif %}
      </div>
    </div>

    <!-- Bad Air Events -->
    <div style="
      background: linear-gradient(135deg, rgba(249, 115, 22, 0.2), rgba(251, 146, 60, 0.1));
      border: 1px solid rgba(249, 115, 22, 0.3);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    ">
      <div style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 10px;">Air DÃ©gradÃ© (Aujourd'hui)</div>
      <div style="font-size: 2.5rem; font-weight: 700; color: #f97316; margin-bottom: 5px;">
        {% if bad_events.bad_events %}{{ bad_events.bad_events }}{% else %}0{% endif %}
      </div>
      <div style="color: #7a8fa6; font-size: 0.85rem;">
        {% if user_settings and user_settings.co2_threshold %}au-dessus de {{ user_settings.co2_threshold }} ppm{% else %}au-dessus de 800 ppm{% endif %}
      </div>
    </div>

    <!-- Weekly Average -->
    <div style="
      background: linear-gradient(135deg, rgba(61, 217, 143, 0.2), rgba(77, 184, 255, 0.1));
      border: 1px solid rgba(61, 217, 143, 0.3);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    ">
      <div style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 10px;">Moyenne (7 jours)</div>
      <div style="font-size: 2.5rem; font-weight: 700; color: #4ade80; margin-bottom: 5px;">
        {% if week_stats.avg_ppm %}{{ week_stats.avg_ppm|round(0)|int }}{% else %}â€”{% endif %} ppm
      </div>
      <div style="color: #7a8fa6; font-size: 0.85rem;">
        {% if week_stats.total_readings %}{{ week_stats.total_readings }} lectures{% else %}Pas de donnÃ©es{% endif %}
      </div>
    </div>
  </div>
</section>

<!-- ================= QUICK ACTIONS ================= -->
<section class="card">
  <h2>ğŸš€ Actions Rapides</h2>
  
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
    <a href="/live" style="
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: rgba(77, 184, 255, 0.1);
      border: 1px solid rgba(77, 184, 255, 0.3);
      border-radius: 8px;
      color: #4db8ff;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.2s ease;
    "
    onmouseover="this.style.background='rgba(77, 184, 255, 0.15)'"
    onmouseout="this.style.background='rgba(77, 184, 255, 0.1)'"
    >
      ğŸ“Š Voir le Direct
    </a>
    
    <a href="/visualization" style="
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: rgba(61, 217, 143, 0.1);
      border: 1px solid rgba(61, 217, 143, 0.3);
      border-radius: 8px;
      color: #3dd98f;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.2s ease;
    "
    onmouseover="this.style.background='rgba(61, 217, 143, 0.15)'"
    onmouseout="this.style.background='rgba(61, 217, 143, 0.1)'"
    >
      ğŸ“ˆ Visualisations
    </a>
    
    <a href="/simulator" style="
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: rgba(249, 115, 22, 0.1);
      border: 1px solid rgba(249, 115, 22, 0.3);
      border-radius: 8px;
      color: #f97316;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.2s ease;
    "
    onmouseover="this.style.background='rgba(249, 115, 22, 0.15)'"
    onmouseout="this.style.background='rgba(249, 115, 22, 0.1)'"
    >
      ğŸ”¬ Simulateur
    </a>
    
    <a href="/settings" style="
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: rgba(139, 92, 246, 0.1);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 8px;
      color: #a78bfa;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.2s ease;
    "
    onmouseover="this.style.background='rgba(139, 92, 246, 0.15)'"
    onmouseout="this.style.background='rgba(139, 92, 246, 0.1)'"
    >
      âš™ï¸ ParamÃ¨tres
    </a>
  </div>
</section>

<!-- ================= ACCOUNT INFO ================= -->
<section class="card">
  <h2>ğŸ‘¤ Informations du Compte</h2>
  
  <div style="
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
  ">
    <div style="padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
      <div style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 8px;">Nom d'utilisateur</div>
      <div style="color: #e5e7eb; font-weight: 600; font-size: 1.1rem;">{{ user.username }}</div>
    </div>
    
    <div style="padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
      <div style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 8px;">Email</div>
      <div style="color: #e5e7eb; font-weight: 600; font-size: 1rem;">{{ user.email }}</div>
    </div>
    
    <div style="padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
      <div style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 8px;">Email VÃ©rifiÃ©</div>
      <div style="font-size: 1.5rem; font-weight: 700;">
        {% if user.email_verified %}
        <span style="color: #4ade80;">âœ“ Oui</span>
        {% else %}
        <span style="color: #ff6b6b;">âœ— Non</span>
        {% endif %}
      </div>
    </div>
    
    <div style="padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
      <div style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 8px;">Compte CrÃ©Ã©</div>
      <div style="color: #e5e7eb; font-weight: 600;">{{ user.created_at.split(' ')[0] if user.created_at else 'N/A' }}</div>
    </div>
  </div>
  
  <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
    <a href="{{ url_for('profile') }}" style="
      display: inline-block;
      padding: 10px 20px;
      background: rgba(77, 184, 255, 0.15);
      border: 1px solid rgba(77, 184, 255, 0.3);
      border-radius: 6px;
      color: #4db8ff;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.2s ease;
    "
    onmouseover="this.style.background='rgba(77, 184, 255, 0.2)'"
    onmouseout="this.style.background='rgba(77, 184, 255, 0.15)'"
    >
      GÃ©rer le Profil â†’
    </a>
  </div>
</section>

<!-- ================= LOGIN HISTORY ================= -->
{% if login_history %}
<section class="card">
  <h2>ğŸ” Historique de Connexion</h2>
  
  <div style="overflow-x: auto;">
    <table style="width: 100%; color: #e5e7eb; font-size: 0.9rem;">
      <thead>
        <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.2);">
          <th style="text-align: left; padding: 12px 10px; color: #9ca3af; font-weight: 600;">Date et Heure</th>
          <th style="text-align: left; padding: 12px 10px; color: #9ca3af; font-weight: 600;">Adresse IP</th>
        </tr>
      </thead>
      <tbody>
        {% for login in login_history %}
        <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
          <td style="padding: 12px 10px;">
            {{ login.login_timestamp }}
          </td>
          <td style="padding: 12px 10px; color: #9ca3af; font-size: 0.85rem;">
            {{ login.ip_address }}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endif %}

<!-- ================= HERO ================= -->
<section class="hero" style="margin-top: 40px;">
  <div class="hero-content">
    <h1>Aerium</h1>
    <p class="hero-sub">
      Surveillance intelligente de la qualitÃ© de l'air en temps rÃ©el
    </p>

    <div class="system-pill paused">
      <span class="dot"></span>
      Analyse en pause
    </div>

    <div class="hero-actions">
      <a href="/live" class="link primary">ğŸ“Š Voir le live</a>
      <button id="export-day-csv" class="link">ğŸ“¥ DonnÃ©es en CSV</button>
      <button id="export-day-pdf" class="link">ğŸ“„ Rapport PDF</button>
      <div class="source-toggle">
        <label for="overview-source">Source</label>
        <select id="overview-source">
          <option value="real">Capteur rÃ©el</option>
          <option value="sim">Simulation</option>
        </select>
      </div>
    </div>
  </div>
</section>

<!-- ================= DAILY STATS ================= -->
<section class="card">
  <h2>Aujourd'hui en chiffres</h2>

  <div class="overview-grid">
    <div class="overview-widget highlight">
      <span class="label">Moyenne COâ‚‚</span>
      <span class="value" id="avg-ppm">â€”</span>
    </div>

    <div class="overview-widget">
      <span class="label">Pic maximum</span>
      <span class="value" id="max-ppm">â€”</span>
    </div>

    <div class="overview-widget">
      <span class="label">Temps en air dÃ©gradÃ©</span>
      <span class="value" id="bad-time">â€”</span>
    </div>
  </div>
</section>

<!-- ================= SYSTEM STATUS ================= -->
<section class="card">
  <h2>Ã‰tat du systÃ¨me</h2>

  <div class="system-status-row">
    <div class="system-status">
      <label>Statut du capteur</label>
      <p id="sensor-status">ğŸ”´ En attente de donnÃ©es</p>
    </div>

    <div class="system-status">
      <label>DerniÃ¨re lecture</label>
      <p id="last-reading">â€”</p>
    </div>

    <div class="system-status">
      <label>Seuil d'alerte</label>
      <button id="threshold-btn" class="link">800 ppm</button>
    </div>
  </div>
</section>

<!-- ================= CHART ================= -->
<section class="card">
  <h2>Historique du jour</h2>
  <canvas id="chart-daily"></canvas>
</section>

<script src="/static/js/overview.js"></script>

{% endif %}

{% endblock %}
