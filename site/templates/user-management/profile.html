{% extends "base.html" %} {% block content %}

<!-- USER PROFILE (for all users) -->
<section class="card">
  <h2>ğŸ‘¤ Mon Profil</h2>
  
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-bottom: 40px;">
    <!-- User Information -->
    <div>
      <h3 style="color: #e5e7eb; margin-bottom: 20px;">Informations Personnelles</h3>
      
      <div style="display: flex; flex-direction: column; gap: 15px;">
        <div style="padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
          <div style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 5px;">Nom d'utilisateur</div>
          <div style="color: #e5e7eb; font-weight: 600; font-size: 1.1rem;">{{ user.username }}</div>
        </div>
        
        <div style="padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
          <div style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 5px;">Email</div>
          <div style="color: #e5e7eb; font-weight: 600;">{{ user.email }}</div>
        </div>
        
        <div style="padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
          <div style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 5px;">RÃ´le</div>
          <div style="font-size: 1.1rem; font-weight: 600;">
            {% if is_admin %}
            <span style="background: rgba(239, 83, 80, 0.2); color: #ff6b6b; padding: 6px 12px; border-radius: 4px; display: inline-block;">ğŸ›¡ï¸ Administrateur</span>
            {% else %}
            <span style="background: rgba(61, 217, 143, 0.2); color: #4ade80; padding: 6px 12px; border-radius: 4px; display: inline-block;">ğŸ‘¤ Utilisateur</span>
            {% endif %}
          </div>
        </div>
        
        <div style="padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
          <div style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 5px;">Email VÃ©rifiÃ©</div>
          <div style="font-size: 1.3rem; font-weight: 700;">
            {% if user.email_verified %}
            <span style="color: #4ade80;">âœ“ Oui</span>
            {% else %}
            <span style="color: #ff6b6b;">âœ— Non</span>
            {% endif %}
          </div>
        </div>
        
        <div style="padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
          <div style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 5px;">Compte CrÃ©Ã©</div>
          <div style="color: #e5e7eb; font-weight: 600;">{{ user.created_at if user.created_at else 'N/A' }}</div>
        </div>
      </div>
    </div>
    
    <!-- Account Actions -->
    <div>
      <h3 style="color: #e5e7eb; margin-bottom: 20px;">Actions du Compte</h3>
      
      <div style="display: flex; flex-direction: column; gap: 12px;">
        <a href="{{ url_for('auth.change_password') }}" style="
          display: block;
          padding: 15px;
          background: rgba(77, 184, 255, 0.1);
          border: 1px solid rgba(77, 184, 255, 0.3);
          border-radius: 8px;
          color: #4db8ff;
          text-decoration: none;
          font-weight: 600;
          transition: all 0.2s ease;
          text-align: center;
        "
        onmouseover="this.style.background='rgba(77, 184, 255, 0.15)'"
        onmouseout="this.style.background='rgba(77, 184, 255, 0.1)'"
        >
          ğŸ” Changer le mot de passe
        </a>
        
        <a href="/settings" style="
          display: block;
          padding: 15px;
          background: rgba(61, 217, 143, 0.1);
          border: 1px solid rgba(61, 217, 143, 0.3);
          border-radius: 8px;
          color: #3dd98f;
          text-decoration: none;
          font-weight: 600;
          transition: all 0.2s ease;
          text-align: center;
        "
        onmouseover="this.style.background='rgba(61, 217, 143, 0.15)'"
        onmouseout="this.style.background='rgba(61, 217, 143, 0.1)'"
        >
          âš™ï¸ ParamÃ¨tres COâ‚‚
        </a>
        
        <a href="/dashboard" style="
          display: block;
          padding: 15px;
          background: rgba(139, 92, 246, 0.1);
          border: 1px solid rgba(139, 92, 246, 0.3);
          border-radius: 8px;
          color: #a78bfa;
          text-decoration: none;
          font-weight: 600;
          transition: all 0.2s ease;
          text-align: center;
        "
        onmouseover="this.style.background='rgba(139, 92, 246, 0.15)'"
        onmouseout="this.style.background='rgba(139, 92, 246, 0.1)'"
        >
          ğŸ“Š Mon Tableau de Bord
        </a>
      </div>
    </div>
  </div>
</section>

<!-- LOGIN HISTORY -->
{% if login_history %}
<section class="card">
  <h2>ğŸ” Historique de Connexion (DerniÃ¨res 5)</h2>
  
  <div style="overflow-x: auto;">
    <table style="width: 100%; color: #e5e7eb; font-size: 0.9rem;">
      <thead>
        <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.2);">
          <th style="text-align: left; padding: 12px 10px; color: #9ca3af; font-weight: 600;">Date et Heure</th>
          <th style="text-align: left; padding: 12px 10px; color: #9ca3af; font-weight: 600;">Adresse IP</th>
        </tr>
      </thead>
      <tbody>
        {% for login in login_history %}
        <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
          <td style="padding: 12px 10px;">{{ login.login_timestamp }}</td>
          <td style="padding: 12px 10px; color: #9ca3af; font-size: 0.85rem;">{{ login.ip_address }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endif %}

<!-- ADMIN DASHBOARD (if user is admin) -->
{% if is_admin %}
<section class="card">
  <h2>âš™ï¸ Admin Dashboard</h2>
  
  <!-- Tab Navigation -->
  <div style="
    display: flex;
    gap: 10px;
    margin-bottom: 30px;
    border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    flex-wrap: wrap;
  ">
    <button 
      class="admin-tab active" 
      onclick="switchTab('overview')"
      style="
        padding: 12px 24px;
        background: none;
        border: none;
        border-bottom: 3px solid #3dd98f;
        color: #e8ecf1;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
      "
      onmouseover="this.style.color='#e8ecf1'"
      onmouseout="this.style.color='#e8ecf1'"
    >
      ğŸ“Š Overview
    </button>
    <button 
      class="admin-tab" 
      onclick="switchTab('users')"
      style="
        padding: 12px 24px;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        color: #9ca3af;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
      "
      onmouseover="this.style.color='#e8ecf1'"
      onmouseout="this.style.color='#9ca3af'"
    >
      ğŸ‘¥ Users
    </button>
    <button 
      class="admin-tab" 
      onclick="switchTab('maintenance')"
      style="
        padding: 12px 24px;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        color: #9ca3af;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
      "
      onmouseover="this.style.color='#e8ecf1'"
      onmouseout="this.style.color='#9ca3af'"
    >
      ğŸ”§ Maintenance
    </button>
    <button 
      class="admin-tab" 
      onclick="switchTab('audit')"
      style="
        padding: 12px 24px;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        color: #9ca3af;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
      "
      onmouseover="this.style.color='#e8ecf1'"
      onmouseout="this.style.color='#9ca3af'"
    >
      ğŸ“‹ Audit Logs
    </button>
  </div>

  <!-- OVERVIEW TAB -->
  <div id="overview-tab" class="admin-tab-content">
    <!-- Statistics Grid -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
      <!-- Total Users -->
      <div style="
        background: linear-gradient(135deg, rgba(61, 217, 143, 0.2), rgba(77, 184, 255, 0.1));
        border: 1px solid rgba(61, 217, 143, 0.3);
        padding: 20px;
        border-radius: 12px;
        text-align: center;
      ">
        <div style="font-size: 2.5rem; font-weight: 700; color: #3dd98f; margin-bottom: 5px;">{{ admin_stats.total_users if admin_stats else 0 }}</div>
        <div style="color: #9ca3af; font-size: 0.9rem;">Total Users</div>
        <div style="color: #7a8fa6; font-size: 0.85rem; margin-top: 5px;">{{ admin_stats.verified_users if admin_stats else 0 }} verified</div>
      </div>

      <!-- Admin Count -->
      <div style="
        background: linear-gradient(135deg, rgba(239, 83, 80, 0.2), rgba(255, 107, 107, 0.1));
        border: 1px solid rgba(239, 83, 80, 0.3);
        padding: 20px;
        border-radius: 12px;
        text-align: center;
      ">
        <div style="font-size: 2.5rem; font-weight: 700; color: #ff6b6b; margin-bottom: 5px;">{{ admin_stats.admin_count if admin_stats else 0 }}</div>
        <div style="color: #9ca3af; font-size: 0.9rem;">Administrators</div>
      </div>

      <!-- CO2 Readings -->
      <div style="
        background: linear-gradient(135deg, rgba(77, 184, 255, 0.2), rgba(61, 217, 143, 0.1));
        border: 1px solid rgba(77, 184, 255, 0.3);
        padding: 20px;
        border-radius: 12px;
        text-align: center;
      ">
        <div style="font-size: 2.5rem; font-weight: 700; color: #4db8ff; margin-bottom: 5px;">{{ admin_stats.total_readings if admin_stats else 0 }}</div>
        <div style="color: #9ca3af; font-size: 0.9rem;">COâ‚‚ Readings</div>
        <div style="color: #7a8fa6; font-size: 0.85rem; margin-top: 5px;">Avg: {{ admin_stats.avg_ppm if admin_stats else 0 }} ppm</div>
      </div>

      <!-- Recent Logins -->
      <div style="
        background: linear-gradient(135deg, rgba(77, 184, 255, 0.2), rgba(61, 217, 143, 0.1));
        border: 1px solid rgba(77, 184, 255, 0.3);
        padding: 20px;
        border-radius: 12px;
        text-align: center;
      ">
        <div style="font-size: 2.5rem; font-weight: 700; color: #4ade80; margin-bottom: 5px;">{{ admin_stats.recent_logins if admin_stats else 0 }}</div>
        <div style="color: #9ca3af; font-size: 0.9rem;">Logins (24h)</div>
      </div>
    </div>

    <!-- Database Info -->
    <div style="margin-top: 30px; padding: 20px; background: rgba(61, 217, 143, 0.05); border: 1px solid rgba(61, 217, 143, 0.2); border-radius: 12px;">
      <h3 style="margin-bottom: 15px; color: #3dd98f;">ğŸ’¾ Database Information</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <div style="padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
          <div style="font-size: 0.85rem; color: #9ca3af; margin-bottom: 5px;">Database Size</div>
          <div style="font-size: 1.3rem; font-weight: 700; color: #e8ecf1;">{{ admin_stats.db_size_mb if admin_stats else 0 }} MB</div>
        </div>
        <div style="padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
          <div style="font-size: 0.85rem; color: #9ca3af; margin-bottom: 5px;">COâ‚‚ Records</div>
          <div style="font-size: 1.3rem; font-weight: 700; color: #e8ecf1;">{{ admin_stats.total_readings if admin_stats else 0 }}</div>
        </div>
        <div style="padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
          <div style="font-size: 0.85rem; color: #9ca3af; margin-bottom: 5px;">Login Records</div>
          <div style="font-size: 1.3rem; font-weight: 700; color: #e8ecf1;">{{ admin_stats.login_records if admin_stats else 0 }}</div>
        </div>
        <div style="padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
          <div style="font-size: 0.85rem; color: #9ca3af; margin-bottom: 5px;">Audit Logs</div>
          <div style="font-size: 1.3rem; font-weight: 700; color: #e8ecf1;">{{ admin_stats.audit_records if admin_stats else 0 }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- USERS TAB -->
  <div id="users-tab" class="admin-tab-content" style="display: none;">
    <h3 style="margin-bottom: 20px; color: #e5e7eb;">ğŸ‘¥ User Management</h3>
    
    <div style="overflow-x: auto;">
      <table style="width: 100%; color: #e5e7eb; font-size: 0.9rem;">
        <thead>
          <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.2);">
            <th style="text-align: left; padding: 15px 10px; color: #9ca3af; font-weight: 600;">Username</th>
            <th style="text-align: left; padding: 15px 10px; color: #9ca3af; font-weight: 600;">Email</th>
            <th style="text-align: center; padding: 15px 10px; color: #9ca3af; font-weight: 600;">Verified</th>
            <th style="text-align: center; padding: 15px 10px; color: #9ca3af; font-weight: 600;">Role</th>
            <th style="text-align: center; padding: 15px 10px; color: #9ca3af; font-weight: 600;">Created</th>
            <th style="text-align: center; padding: 15px 10px; color: #9ca3af; font-weight: 600;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in admin_users %}
          <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.05); padding: 10px 0;">
            <td style="padding: 15px 10px;">
              <strong>{{ user.username }}</strong>
            </td>
            <td style="padding: 15px 10px; font-size: 0.85rem; color: #9ca3af;">
              {{ user.email }}
            </td>
            <td style="padding: 15px 10px; text-align: center;">
              {% if user.email_verified %}
              <span style="color: #4ade80;">âœ“</span>
              {% else %}
              <span style="color: #ff6b6b;">âœ—</span>
              {% endif %}
            </td>
            <td style="padding: 15px 10px; text-align: center;">
              {% if user.role == 'admin' %}
              <span style="background: rgba(239, 83, 80, 0.2); color: #ff6b6b; padding: 4px 8px; border-radius: 4px; font-weight: 600;">Admin</span>
              {% else %}
              <span style="background: rgba(61, 217, 143, 0.2); color: #4ade80; padding: 4px 8px; border-radius: 4px;">User</span>
              {% endif %}
            </td>
            <td style="padding: 15px 10px; text-align: center; font-size: 0.85rem; color: #9ca3af;">
              {{ user.created_at.split(' ')[0] if user.created_at else 'N/A' }}
            </td>
            <td style="padding: 15px 10px; text-align: center; display: flex; gap: 8px; justify-content: center;">
              {% if user.id != session.get('user_id') %}
              <button 
                onclick="toggleRole({{ user.id }}, '{{ user.role }}')"
                style="
                  padding: 6px 12px;
                  background: {% if user.role == 'user' %}rgba(61, 217, 143, 0.2){% else %}rgba(77, 184, 255, 0.2){% endif %};
                  border: 1px solid {% if user.role == 'user' %}rgba(61, 217, 143, 0.3){% else %}rgba(77, 184, 255, 0.3){% endif %};
                  color: {% if user.role == 'user' %}#4ade80{% else %}#4db8ff{% endif %};
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 0.8rem;
                  font-weight: 600;
                  transition: all 0.2s ease;
                "
                onmouseover="this.style.opacity='0.8'"
                onmouseout="this.style.opacity='1'"
              >
                {% if user.role == 'user' %}ğŸ‘‘{% else %}ğŸ‘¤{% endif %}
              </button>
              <button 
                onclick="deleteUser({{ user.id }}, '{{ user.username }}')"
                style="
                  padding: 6px 12px;
                  background: rgba(239, 83, 80, 0.2);
                  border: 1px solid rgba(239, 83, 80, 0.3);
                  color: #ff6b6b;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 0.8rem;
                  font-weight: 600;
                  transition: all 0.2s ease;
                "
                onmouseover="this.style.opacity='0.8'"
                onmouseout="this.style.opacity='1'"
              >
                ğŸ—‘ï¸
              </button>
              {% else %}
              <span style="color: #9ca3af; font-size: 0.85rem;">You</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- MAINTENANCE TAB -->
  <div id="maintenance-tab" class="admin-tab-content" style="display: none;">
    <h3 style="margin-bottom: 20px; color: #e5e7eb;">ğŸ”§ Maintenance Tools</h3>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
      <!-- Cleanup Old CO2 Data -->
      <div style="
        padding: 20px;
        background: rgba(239, 83, 80, 0.05);
        border: 1px solid rgba(239, 83, 80, 0.2);
        border-radius: 12px;
      ">
        <h4 style="color: #ff6b6b; margin-bottom: 12px;">ğŸ—‘ï¸ Cleanup Old COâ‚‚ Data</h4>
        <p style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 15px;">Remove COâ‚‚ readings older than specified days.</p>
        <div style="display: flex; gap: 10px; margin-bottom: 12px;">
          <input 
            type="number" 
            id="cleanup_data_days" 
            placeholder="Days to keep" 
            value="90"
            style="
              flex: 1;
              padding: 8px 12px;
              background: rgba(255, 255, 255, 0.05);
              border: 1px solid rgba(255, 255, 255, 0.1);
              color: #e8ecf1;
              border-radius: 6px;
              font-size: 0.9rem;
            "
          />
          <button 
            onclick="runMaintenance('cleanup_old_data', 'cleanup_data_days')"
            style="
              padding: 8px 16px;
              background: rgba(239, 83, 80, 0.2);
              border: 1px solid rgba(239, 83, 80, 0.3);
              color: #ff6b6b;
              border-radius: 6px;
              cursor: pointer;
              font-weight: 600;
              transition: all 0.2s ease;
            "
            onmouseover="this.style.opacity='0.8'"
            onmouseout="this.style.opacity='1'"
          >
            Execute
          </button>
        </div>
        <div id="cleanup_data_result" style="font-size: 0.85rem; color: #9ca3af;"></div>
      </div>

      <!-- Cleanup Audit Logs -->
      <div style="
        padding: 20px;
        background: rgba(77, 184, 255, 0.05);
        border: 1px solid rgba(77, 184, 255, 0.2);
        border-radius: 12px;
      ">
        <h4 style="color: #4db8ff; margin-bottom: 12px;">ğŸ“‹ Cleanup Audit Logs</h4>
        <p style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 15px;">Remove audit logs older than specified days.</p>
        <div style="display: flex; gap: 10px; margin-bottom: 12px;">
          <input 
            type="number" 
            id="cleanup_logs_days" 
            placeholder="Days to keep" 
            value="180"
            style="
              flex: 1;
              padding: 8px 12px;
              background: rgba(255, 255, 255, 0.05);
              border: 1px solid rgba(255, 255, 255, 0.1);
              color: #e8ecf1;
              border-radius: 6px;
              font-size: 0.9rem;
            "
          />
          <button 
            onclick="runMaintenance('cleanup_old_logs', 'cleanup_logs_days')"
            style="
              padding: 8px 16px;
              background: rgba(77, 184, 255, 0.2);
              border: 1px solid rgba(77, 184, 255, 0.3);
              color: #4db8ff;
              border-radius: 6px;
              cursor: pointer;
              font-weight: 600;
              transition: all 0.2s ease;
            "
            onmouseover="this.style.opacity='0.8'"
            onmouseout="this.style.opacity='1'"
          >
            Execute
          </button>
        </div>
        <div id="cleanup_logs_result" style="font-size: 0.85rem; color: #9ca3af;"></div>
      </div>

      <!-- Cleanup Login History -->
      <div style="
        padding: 20px;
        background: rgba(61, 217, 143, 0.05);
        border: 1px solid rgba(61, 217, 143, 0.2);
        border-radius: 12px;
      ">
        <h4 style="color: #3dd98f; margin-bottom: 12px;">ğŸ” Cleanup Login History</h4>
        <p style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 15px;">Remove login records older than specified days.</p>
        <div style="display: flex; gap: 10px; margin-bottom: 12px;">
          <input 
            type="number" 
            id="cleanup_logins_days" 
            placeholder="Days to keep" 
            value="90"
            style="
              flex: 1;
              padding: 8px 12px;
              background: rgba(255, 255, 255, 0.05);
              border: 1px solid rgba(255, 255, 255, 0.1);
              color: #e8ecf1;
              border-radius: 6px;
              font-size: 0.9rem;
            "
          />
          <button 
            onclick="runMaintenance('cleanup_login_history', 'cleanup_logins_days')"
            style="
              padding: 8px 16px;
              background: rgba(61, 217, 143, 0.2);
              border: 1px solid rgba(61, 217, 143, 0.3);
              color: #3dd98f;
              border-radius: 6px;
              cursor: pointer;
              font-weight: 600;
              transition: all 0.2s ease;
            "
            onmouseover="this.style.opacity='0.8'"
            onmouseout="this.style.opacity='1'"
          >
            Execute
          </button>
        </div>
        <div id="cleanup_logins_result" style="font-size: 0.85rem; color: #9ca3af;"></div>
      </div>

      <!-- CSV Data Import -->
      <div style="
        padding: 20px;
        background: rgba(249, 199, 79, 0.05);
        border: 1px solid rgba(249, 199, 79, 0.2);
        border-radius: 12px;
      ">
        <h4 style="color: #f9c74f; margin-bottom: 12px;">ğŸ“¥ Import COâ‚‚ Data (CSV)</h4>
        <p style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 15px;">Import historical COâ‚‚ readings from CSV file. Format: timestamp, ppm</p>
        <div style="margin-bottom: 12px;">
          <input 
            type="file" 
            id="csv_import_file" 
            accept=".csv"
            style="
              padding: 8px 12px;
              background: rgba(255, 255, 255, 0.05);
              border: 1px solid rgba(255, 255, 255, 0.1);
              color: #e8ecf1;
              border-radius: 6px;
              font-size: 0.9rem;
              width: 100%;
              cursor: pointer;
            "
          />
        </div>
        <button 
          onclick="importCSV()"
          style="
            width: 100%;
            padding: 10px 16px;
            background: rgba(249, 199, 79, 0.2);
            border: 1px solid rgba(249, 199, 79, 0.3);
            color: #f9c74f;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
          "
          onmouseover="this.style.opacity='0.8'"
          onmouseout="this.style.opacity='1'"
        >
          Upload & Import
        </button>
        <div id="csv_import_result" style="
          font-size: 0.85rem; 
          color: #9ca3af;
          margin-top: 12px;
          padding: 12px;
          background: rgba(255, 255, 255, 0.02);
          border-radius: 6px;
          display: none;
        "></div>
      </div>
    </div>
  </div>

  <!-- AUDIT LOGS TAB -->
  <div id="audit-tab" class="admin-tab-content" style="display: none;">
    <h3 style="margin-bottom: 20px; color: #e5e7eb;">ğŸ“‹ Audit Logs</h3>
    
    <div style="overflow-x: auto;">
      <table style="width: 100%; color: #e5e7eb; font-size: 0.9rem;">
        <thead>
          <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.2);">
            <th style="text-align: left; padding: 15px 10px; color: #9ca3af; font-weight: 600;">Time</th>
            <th style="text-align: left; padding: 15px 10px; color: #9ca3af; font-weight: 600;">Admin</th>
            <th style="text-align: left; padding: 15px 10px; color: #9ca3af; font-weight: 600;">Action</th>
            <th style="text-align: left; padding: 15px 10px; color: #9ca3af; font-weight: 600;">Target</th>
            <th style="text-align: left; padding: 15px 10px; color: #9ca3af; font-weight: 600;">Details</th>
          </tr>
        </thead>
        <tbody>
          {% if audit_logs %}
            {% for log in audit_logs %}
            <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.05); padding: 10px 0;">
              <td style="padding: 15px 10px; font-size: 0.85rem; color: #9ca3af;">
                {{ log.timestamp }}
              </td>
              <td style="padding: 15px 10px;">
                <strong>{{ log.admin_name }}</strong>
              </td>
              <td style="padding: 15px 10px;">
                <span style="
                  background: rgba(61, 217, 143, 0.2);
                  color: #3dd98f;
                  padding: 4px 8px;
                  border-radius: 4px;
                  font-size: 0.85rem;
                  font-weight: 600;
                ">{{ log.action }}</span>
              </td>
              <td style="padding: 15px 10px; font-size: 0.85rem; color: #9ca3af;">
                {% if log.target_type %}{{ log.target_type }}{% if log.target_id %} #{{ log.target_id }}{% endif %}{% else %}â€”{% endif %}
              </td>
              <td style="padding: 15px 10px; font-size: 0.85rem; color: #9ca3af;">
                {% if log.old_value %}{{ log.old_value }}{% endif %} {% if log.new_value %}â†’ {{ log.new_value }}{% endif %}
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
              <td colspan="5" style="padding: 20px 10px; text-align: center; color: #9ca3af;">
                No audit logs available
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</section>

{% endif %}


<script>
function switchTab(tabName) {
  // Hide all tabs
  const tabs = document.querySelectorAll('.admin-tab-content');
  tabs.forEach(tab => tab.style.display = 'none');
  
  // Show selected tab
  document.getElementById(tabName + '-tab').style.display = 'block';
  
  // Update button styles
  const buttons = document.querySelectorAll('.admin-tab');
  buttons.forEach(btn => {
    btn.style.borderBottomColor = 'transparent';
    btn.style.color = '#9ca3af';
  });
  
  // Highlight active button
  event.target.style.borderBottomColor = '#3dd98f';
  event.target.style.color = '#e8ecf1';
}

function toggleRole(userId, currentRole) {
  const newRole = currentRole === 'admin' ? 'user' : 'admin';
  const action = newRole === 'admin' ? 'Make Admin' : 'Remove Admin';
  
  if (!confirm(`Are you sure you want to ${action} this user?`)) {
    return;
  }
  
  fetch(`/admin/user/${userId}/role/${newRole}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      location.reload();
    } else {
      alert('Error: ' + (data.error || 'Failed to update role'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to update user role');
  });
}

function deleteUser(userId, username) {
  if (!confirm(`âš ï¸ This will permanently delete ${username}'s account and all their data.\n\nAre you absolutely sure?`)) {
    return;
  }
  
  fetch(`/admin/user/${userId}/delete`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      location.reload();
    } else {
      alert('Error: ' + (data.error || 'Failed to delete user'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to delete user');
  });
}

function runMaintenance(task, daysInputId) {
  const days = parseInt(document.getElementById(daysInputId).value) || 90;
  const resultDiv = document.getElementById(task.replace('cleanup_', 'cleanup_') + '_result');
  
  resultDiv.textContent = 'â³ Running...';
  resultDiv.style.color = '#f9c74f';
  
  fetch('/admin/maintenance', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ task, days })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      let message = 'âœ… Success! ';
      if (data.deleted_readings) message += `Deleted ${data.deleted_readings} readings.`;
      if (data.deleted_audit_logs) message += `Deleted ${data.deleted_audit_logs} audit logs.`;
      if (data.deleted_logins) message += `Deleted ${data.deleted_logins} login records.`;
      
      resultDiv.textContent = message;
      resultDiv.style.color = '#3dd98f';
    } else {
      resultDiv.textContent = 'âŒ Error: ' + (data.error || 'Unknown error');
      resultDiv.style.color = '#ff6b6b';
    }
  })
  .catch(error => {
    console.error('Error:', error);
    resultDiv.textContent = 'âŒ Failed to run maintenance task';
    resultDiv.style.color = '#ff6b6b';
  });
}

function importCSV() {
  const fileInput = document.getElementById('csv_import_file');
  const resultDiv = document.getElementById('csv_import_result');
  
  if (!fileInput.files || !fileInput.files[0]) {
    resultDiv.style.display = 'block';
    resultDiv.textContent = 'âŒ Please select a CSV file';
    resultDiv.style.color = '#ff6b6b';
    return;
  }
  
  const file = fileInput.files[0];
  
  if (!file.name.endsWith('.csv')) {
    resultDiv.style.display = 'block';
    resultDiv.textContent = 'âŒ File must be in CSV format';
    resultDiv.style.color = '#ff6b6b';
    return;
  }
  
  const formData = new FormData();
  formData.append('file', file);
  
  resultDiv.style.display = 'block';
  resultDiv.textContent = 'â³ Uploading and importing...';
  resultDiv.style.color = '#f9c74f';
  
  fetch('/api/import/csv', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    resultDiv.style.display = 'block';
    
    if (data.success) {
      let message = `âœ… Import successful! `;
      message += `${data.imported}/${data.total} readings imported.`;
      
      if (data.errors && data.errors.length > 0) {
        message += `\n\nâš ï¸ ${data.errors.length} errors found:\n`;
        message += data.errors.slice(0, 5).join('\n');
        if (data.errors.length > 5) {
          message += `\n... and ${data.errors.length - 5} more errors`;
        }
        resultDiv.style.color = '#f9c74f';
      } else {
        resultDiv.style.color = '#3dd98f';
      }
      
      resultDiv.innerHTML = message.replace(/\n/g, '<br>');
      fileInput.value = '';
    } else {
      resultDiv.textContent = 'âŒ ' + (data.error || 'Import failed');
      resultDiv.style.color = '#ff6b6b';
    }
  })
  .catch(error => {
    console.error('Error:', error);
    resultDiv.style.display = 'block';
    resultDiv.textContent = 'âŒ Failed to upload file: ' + error.message;
    resultDiv.style.color = '#ff6b6b';
  });
}
</script>

{% endblock %}
