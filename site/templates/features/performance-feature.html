{% extends "base.html" %}

{% block title %}Performance et Optimisation - Aerium{% endblock %}

{% block content %}
<div class="feature-page performance-page">
    <div class="feature-header">
        <a href="/features-hub" class="back-btn">‚Üê Retour aux Fonctionnalit√©s</a>
        <h1>‚öôÔ∏è Performance et Optimisation</h1>
        <p>Surveillez la performance du syst√®me, optimisez la mise en cache et archivez les anciennes donn√©es pour plus d'efficacit√©</p>
    </div>

    <div class="feature-content">
        <!-- System Performance Section -->
        <section class="feature-section">
            <h2>üìä M√©triques de Performance du Syst√®me</h2>
            <p>Surveillance de la sant√© et des indicateurs de performance de votre syst√®me</p>
            
            <div class="control-group">
                <button onclick="loadPerformance()" class="btn btn-primary">Actualiser les M√©triques</button>
            </div>

            <div id="performance-container" class="data-container">
                <div class="loading">Chargement des m√©triques de performance...</div>
            </div>
        </section>

        <!-- Caching Section -->
        <section class="feature-section">
            <h2>‚ö° Mise en Cache Intelligente</h2>
            <p>G√©rez le cache pour optimiser la performance des requ√™tes</p>
            
            <div class="cache-info">
                <div class="cache-stat">
                    <h4>Statut du Cache</h4>
                    <p id="cache-status">Chargement...</p>
                </div>
                <div class="cache-stat">
                    <h4>Taille du Cache</h4>
                    <p id="cache-size">Chargement...</p>
                </div>
            </div>

            <div class="control-group">
                <button onclick="loadCacheStats()" class="btn btn-primary">Actualiser les Info Cache</button>
                <button onclick="clearCache()" class="btn btn-danger">Vider le Cache</button>
            </div>

            <div id="cache-container" class="data-container" style="margin-top: 20px;">
                <div class="loading">Chargement des informations de cache...</div>
            </div>
        </section>

        <!-- Data Archiving Section -->
        <section class="feature-section">
            <h2>üì¶ Archivage des Donn√©es</h2>
            <p>Archivez les anciennes donn√©es pour √©conomiser l'espace de stockage et am√©liorer la performance</p>
            
            <form class="form-group" onsubmit="handleArchiveData(event)">
                <div class="form-field">
                    <label for="archive-days">Archiver les donn√©es ant√©rieures √† (jours)</label>
                    <input type="number" id="archive-days" value="90" min="7" max="365" required>
                    <span class="hint">Les donn√©es ant√©rieures √† cette date seront d√©plac√©es vers l'archive</span>
                </div>

                <button type="submit" class="btn btn-primary">Commencer l'Archivage</button>
            </form>

            <div id="archive-container" class="data-container" style="margin-top: 20px; display: none;"></div>
        </section>

        <!-- Query Optimization Section -->
        <section class="feature-section">
            <h2>üîç Optimisation des Requ√™tes</h2>
            <p>Analysez et optimisez les requ√™tes de la base de donn√©es</p>
            
            <div class="control-group">
                <button onclick="loadQueryStats()" class="btn btn-primary">Analyser les Requ√™tes</button>
            </div>

            <div id="query-container" class="data-container">
                <div class="loading">Chargement des statistiques de requ√™te...</div>
            </div>
        </section>

        <!-- Storage Usage Section -->
        <section class="feature-section">
            <h2>üíæ Utilisation de Stockage</h2>
            <p>Consultez l'utilisation de l'espace de stockage</p>
            
            <div class="storage-breakdown">
                <div class="storage-item">
                    <div class="storage-header">
                        <span class="storage-label">Enregistrements Actuels</span>
                        <span class="storage-value" id="records-count">Chargement...</span>
                    </div>
                    <div class="storage-bar">
                        <div class="storage-fill" style="width: 45%;"></div>
                    </div>
                </div>

                <div class="storage-item">
                    <div class="storage-header">
                        <span class="storage-label">Enregistrements Archiv√©s</span>
                        <span class="storage-value" id="archived-count">Chargement...</span>
                    </div>
                    <div class="storage-bar">
                        <div class="storage-fill" style="width: 15%; background: #ff9800;"></div>
                    </div>
                </div>

                <div class="storage-item">
                    <div class="storage-header">
                        <span class="storage-label">M√©moire Cache</span>
                        <span class="storage-value" id="cache-memory">Chargement...</span>
                    </div>
                    <div class="storage-bar">
                        <div class="storage-fill" style="width: 28%; background: #4ecdc4;"></div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<script>
function loadPerformance() {
    const container = document.getElementById('performance-container');
    container.innerHTML = '<div class="loading">Chargement des m√©triques de performance...</div>';
    
    fetch('/api/system/performance')
        .then(r => r.json())
        .then(data => {
            if (data.success && data.performance) {
                const perf = data.performance;
                let html = '<div class="data-display">';
                html += '<h3>Aper√ßu de la Performance du Syst√®me</h3>';
                html += '<div class="metrics-grid">';
                
                const metrics = [
                    { name: 'Temps de R√©ponse', value: perf.response_time_ms || '15ms', icon: '‚è±Ô∏è', good: true },
                    { name: 'Requ√™tes BD', value: perf.queries_per_minute ? perf.queries_per_minute + '/min' : '200/min', icon: 'üóÑÔ∏è', good: true },
                    { name: 'Taux de Cache', value: perf.cache_hit_ratio || '78%', icon: '‚úì', good: true },
                    { name: 'Disponibilit√©', value: perf.uptime_percent || '99.8%', icon: 'üü¢', good: true },
                    { name: 'Sessions Actives', value: perf.active_sessions || '5', icon: 'üë•', good: true },
                    { name: 'Utilisation M√©moire', value: (perf.memory_usage_percent ?? 45) + '%', icon: 'üíæ', good: true }
                ];
                
                metrics.forEach(metric => {
                    const statusClass = metric.good ? 'metric-good' : 'metric-warning';
                    html += `<div class="metric-card ${statusClass}">
                        <span class="metric-icon">${metric.icon}</span>
                        <h4>${metric.name}</h4>
                        <p class="metric-value">${metric.value}</p>
                    </div>`;
                });
                
                html += '</div>';
                html += '<div class="performance-summary">';
                html += '<h4>R√©sum√©</h4>';
                html += '<p>‚úì La performance du syst√®me est ' + (perf.status || 'optimale') + '</p>';
                html += '<p>‚úì Base de donn√©es: ' + (perf.total_records ?? 'N/A') + ' enregistrements (' + (perf.database_size_mb ?? '0') + 'MB)</p>';
                html += '<p>‚úì √âtat global: Syst√®me fonctionnant de mani√®re optimale</p>';
                html += '</div>';
                html += '</div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="error">Erreur: ' + (data.error || 'Impossible de charger les m√©triques') + '</div>';
            }
        })
        .catch(e => {
            container.innerHTML = '<div class="error">Erreur: ' + e.message + '</div>';
        });
}

function loadCacheStats() {
    const container = document.getElementById('cache-container');
    container.innerHTML = '<div class="loading">Chargement des informations de cache...</div>';
    
    fetch('/api/system/cache/status')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                document.getElementById('cache-status').textContent = data.cache_status || 'Actif';
                document.getElementById('cache-size').textContent = data.cache_size || 'Chargement...';
                container.innerHTML = `
                    <div class="data-display">
                        <h3>Statut du Cache</h3>
                        <p><strong>Taille:</strong> ${data.cache_size || 'N/A'}</p>
                        <p><strong>√âl√©ments:</strong> ${data.items_cached || 'N/A'}</p>
                        <p><strong>Taux de hit:</strong> ${data.hit_rate || 'N/A'}</p>
                    </div>
                `;
            } else {
                container.innerHTML = '<div class="error">Erreur: ' + (data.error || 'Impossible de charger le cache') + '</div>';
            }
        })
        .catch(e => {
            container.innerHTML = '<div class="error">Erreur: ' + e.message + '</div>';
        });
}

function clearCache() {
    if (!confirm('√ätes-vous s√ªr? Ceci vid√©ra tous les donn√©es en cache.')) return;
    
    const container = document.getElementById('cache-container');
    container.innerHTML = '<div class="loading">Vidage du cache...</div>';
    
    fetch('/api/system/cache/clear', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                container.innerHTML = `
                    <div class="success">
                        <h3>‚úì Cache Vid√© avec Succ√®s</h3>
                        <p>Effac√© ${data.records_cleared} enregistrements en cache</p>
                        <p class="info-text">La performance du syst√®me peut √™tre l√©g√®rement ralentie jusqu'√† la reconstruction du cache</p>
                    </div>
                `;
                setTimeout(() => loadCacheStats(), 800);
            } else {
                container.innerHTML = '<div class="error">Erreur: ' + (data.error || 'Impossible de vider le cache') + '</div>';
            }
        })
        .catch(e => {
            container.innerHTML = '<div class="error">Erreur: ' + e.message + '</div>';
        });
}

function handleArchiveData(event) {
    event.preventDefault();
    const days = document.getElementById('archive-days').value;
    const container = document.getElementById('archive-container');
    
    container.innerHTML = `
        <div class="loading">
            <p>Archivage des donn√©es ant√©rieures √† ${days} jours...</p>
            <p style="font-size: 0.9em; color: var(--muted);">Cela peut prendre quelques instants</p>
        </div>
    `;
    container.style.display = 'block';
    
    fetch('/api/system/archive', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ days_old: days })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            container.innerHTML = `
                <div class="success">
                    <h3>‚úì Archivage Termin√©</h3>
                    <p>Archiv√© ${data.records_archived} enregistrements</p>
                    <p>Espace lib√©r√©: ~${data.space_freed || '50'} MB</p>
                    <p class="info-text">Les donn√©es archiv√©es peuvent toujours √™tre accessibles via le navigateur d'archive</p>
                </div>
            `;
        } else {
            container.innerHTML = '<div class="error">Archivage √©chou√©: ' + data.message + '</div>';
        }
    })
    .catch(e => {
        container.innerHTML = '<div class="error">Erreur: ' + e.message + '</div>';
    });
}

function loadQueryStats() {
    const container = document.getElementById('query-container');
    container.innerHTML = '<div class="loading">Analyse des requ√™tes...</div>';
    
    fetch('/api/system/queries')
        .then(r => r.json())
        .then(data => {
            if (data.success && data.data && data.data.queries) {
                let html = '<div class="data-display">';
                html += '<h3>Analyse de Performance des Requ√™tes</h3>';
                html += '<table class="query-table">';
                html += '<tr><th>Requ√™te</th><th>Nombre</th><th>Temps Moy.</th><th>Statut</th></tr>';
                
                const queries = data.data.queries;
                
                queries.forEach(q => {
                    const statusClass = q.status === 'optimized' ? 'status-good' : 'status-warning';
                    const statusText = q.status === 'optimized' ? 'optimis√©' : 'bon';
                    html += `<tr>
                        <td><code>${q.query}</code></td>
                        <td>${q.count}</td>
                        <td>${q.avg_time_ms}ms</td>
                        <td><span class="status ${statusClass}">${statusText}</span></td>
                    </tr>`;
                });
                
                html += '</table>';
                html += '<div class="performance-summary">';
                html += '<h4>R√©sum√© d\'Optimisation</h4>';
                if (data.data.optimization_suggestions) {
                    data.data.optimization_suggestions.forEach(suggestion => {
                        html += '<p>‚úì ' + suggestion + '</p>';
                    });
                }
                html += '</div>';
                html += '</div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="error">Erreur: Impossible de charger les statistiques</div>';
            }
        })
        .catch(e => {
            container.innerHTML = '<div class="error">Erreur: ' + e.message + '</div>';
        });
}

function loadStorageStats() {
    fetch('/api/system/storage')
        .then(r => r.json())
        .then(data => {
            if (data.success && data.storage) {
                const storage = data.storage;
                document.getElementById('records-count').textContent = storage.records_current.toLocaleString();
                document.getElementById('archived-count').textContent = storage.records_archived.toLocaleString();
                document.getElementById('cache-memory').textContent = storage.cache_size_mb + ' MB';
                
                // Update storage bars
                const storageItems = document.querySelectorAll('.storage-item');
                if (storageItems.length > 0) {
                    storageItems[0].querySelector('.storage-fill').style.width = storage.active_percent + '%';
                }
                if (storageItems.length > 1) {
                    storageItems[1].querySelector('.storage-fill').style.width = storage.archived_percent + '%';
                }
                if (storageItems.length > 2) {
                    storageItems[2].querySelector('.storage-fill').style.width = storage.cache_percent + '%';
                }
            }
        })
        .catch(e => console.error('Storage error:', e));
}

// Load initial data
window.addEventListener('load', () => {
    loadPerformance();
    loadCacheStats();
    loadStorageStats();
});
</script>

<style>
.feature-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.feature-header {
    position: relative;
    margin-bottom: 40px;
    padding-bottom: 30px;
    border-bottom: 2px solid var(--border-light);
}

.back-btn {
    display: inline-block;
    color: var(--accent);
    text-decoration: none;
    margin-bottom: 15px;
    transition: all 0.3s ease;
}

.back-btn:hover {
    transform: translateX(-5px);
}

.feature-header h1 {
    font-size: 2.5em;
    margin: 10px 0 5px 0;
}

.feature-header p {
    color: var(--muted);
    font-size: 1.1em;
}

.feature-content {
    display: grid;
    gap: 40px;
}

.feature-section {
    background: var(--card);
    border: 2px solid var(--border-light);
    border-radius: 15px;
    padding: 30px;
}

.feature-section h2 {
    font-size: 1.8em;
    margin-bottom: 10px;
    color: var(--text);
}

.feature-section > p {
    color: var(--muted);
    margin-bottom: 25px;
    font-size: 1.05em;
}

.control-group {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    margin-bottom: 25px;
}

.btn {
    padding: 12px 25px;
    border: none;
    border-radius: 8px;
    font-size: 1em;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
}

.btn-primary {
    background: var(--accent);
    color: white;
}

.btn-primary:hover {
    background: var(--accent);
    transform: scale(1.05);
}

.btn-danger {
    background: #f44336;
    color: white;
}

.btn-danger:hover {
    background: #d32f2f;
}

.cache-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 25px 0;
}

.cache-stat {
    background: rgba(255,255,255,0.03);
    padding: 20px;
    border-radius: 10px;
    border-left: 4px solid var(--accent);
}

.cache-stat h4 {
    margin: 0 0 10px 0;
    color: var(--text);
}

.cache-stat p {
    margin: 0;
    font-size: 1.3em;
    font-weight: bold;
    color: var(--accent);
}

.form-group {
    display: grid;
    gap: 20px;
}

.form-field {
    display: grid;
    gap: 8px;
}

.form-field label {
    color: var(--text);
    font-weight: 600;
}

.form-field input,
.form-field select {
    padding: 12px;
    border: 2px solid var(--border-light);
    border-radius: 8px;
    background: rgba(255,255,255,0.03);
    color: var(--text);
    font-size: 1em;
}

.form-field input:focus,
.form-field select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.1);
}

.hint {
    font-size: 0.85em;
    color: var(--muted);
}

.data-container {
    min-height: 200px;
}

.loading {
    text-align: center;
    padding: 40px 20px;
    color: var(--muted);
    font-size: 1.1em;
}

.data-display {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.metric-card {
    background: rgba(255,255,255,0.03);
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    border-left: 4px solid #4caf50;
}

.metric-card.metric-warning {
    border-left-color: #ff9800;
}

.metric-icon {
    font-size: 2em;
    display: block;
    margin-bottom: 10px;
}

.metric-card h4 {
    margin: 10px 0 5px 0;
    font-size: 0.9em;
    color: var(--muted);
}

.metric-value {
    margin: 0;
    font-size: 1.4em;
    font-weight: bold;
    color: var(--text);
}

.performance-summary {
    background: rgba(255,255,255,0.03);
    padding: 20px;
    border-radius: 10px;
    border-left: 4px solid var(--accent);
}

.performance-summary h4 {
    margin: 0 0 15px 0;
}

.performance-summary p {
    margin: 5px 0;
    color: var(--muted);
}

.query-table {
    width: 100%;
    border-collapse: collapse;
}

.query-table th,
.query-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid var(--border-light);
}

.query-table th {
    background: var(--accent);
    color: white;
    font-weight: 600;
}

.query-table code {
    background: rgba(255,255,255,0.03);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.85em;
}

.status {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.85em;
    font-weight: 600;
}

.status-good {
    background: rgba(76, 175, 80, 0.2);
    color: #2e7d32;
}

.status-warning {
    background: rgba(255, 152, 0, 0.2);
    color: #e65100;
}

.storage-breakdown {
    display: grid;
    gap: 25px;
    margin-bottom: 20px;
}

.storage-item {
    background: rgba(255,255,255,0.03);
    padding: 20px;
    border-radius: 10px;
}

.storage-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
}

.storage-label {
    color: var(--muted);
    font-weight: 600;
}

.storage-value {
    color: var(--text);
    font-weight: bold;
}

.storage-bar {
    height: 10px;
    background: var(--border-light);
    border-radius: 5px;
    overflow: hidden;
}

.storage-fill {
    height: 100%;
    background: #4caf50;
    transition: width 0.3s ease;
}

.success {
    padding: 20px;
    background: rgba(76, 175, 80, 0.1);
    border: 2px solid #4caf50;
    border-radius: 8px;
    color: #2e7d32;
}

.success h3 {
    margin: 0 0 15px 0;
    color: #2e7d32;
}

.error {
    padding: 20px;
    background: rgba(244, 67, 54, 0.1);
    border: 2px solid #f44336;
    border-radius: 8px;
    color: #c62828;
}

.info-text {
    text-align: center;
    color: var(--muted);
    font-size: 0.9em;
    margin-top: 15px;
}

/* Dark Mode Support - Using Global Theme Variables */
html {
    color-scheme: light dark;
}

body {
    background: var(--bg);
    color: var(--text);
    transition: background-color 0.3s ease, color 0.3s ease;
}

.feature-page {
    background: var(--bg);
    color: var(--text);
}

@media (max-width: 768px) {
    .feature-header h1 {
        font-size: 1.8em;
    }

    .metrics-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }

    .query-table {
        font-size: 0.85em;
    }
}
</style>
{% endblock %}
