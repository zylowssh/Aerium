{% extends "base.html" %}

{% block title %}Export et Rapports{% endblock %}

{% block content %}
<style>
  .page-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 50px 40px;
    border-radius: 16px;
    color: white;
    margin-bottom: 40px;
    box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4);
    text-align: center;
  }

  .page-header h1 {
    margin: 0 0 15px 0;
    font-size: 2.8em;
    font-weight: 700;
    letter-spacing: -0.5px;
  }

  .page-header p {
    margin: 0;
    opacity: 0.95;
    font-size: 1.15em;
    font-weight: 300;
  }

  .back-link {
    display: inline-block;
    margin-bottom: 20px;
    color: rgba(255, 255, 255, 0.9);
    text-decoration: none;
    transition: all 0.3s ease;
    font-size: 0.95em;
  }

  .back-link:hover {
    opacity: 0.7;
    transform: translateX(-5px);
  }

  .export-container {
    background: var(--bg);
    min-height: 100vh;
    padding: 2rem;
  }

  .tabs {
    display: flex;
    gap: 0;
    margin-bottom: 2rem;
    border-bottom: 2px solid rgba(102, 126, 234, 0.2);
  }

  .tab-button {
    background: transparent;
    border: none;
    color: var(--muted);
    padding: 1rem 1.5rem;
    font-size: 1rem;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.3s ease;
    font-weight: 500;
  }

  .tab-button:hover {
    color: var(--accent);
  }

  .tab-button.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
    animation: fadeIn 0.3s ease-in;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .stat-card {
    background: var(--card);
    padding: 1.5rem;
    border-radius: 12px;
    border: 1px solid rgba(102, 126, 234, 0.3);
  }

  .stat-label {
    color: var(--muted);
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
  }

  .stat-value {
    color: var(--text);
    font-size: 2rem;
    font-weight: 700;
  }

  .format-buttons {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 2rem;
  }

  .btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    font-size: 1rem;
  }

  .btn-primary {
    background: var(--accent);
    color: white;
  }

  .btn-primary:hover {
    background: var(--accent-alt);
    transform: translateY(-2px);
  }

  .btn-secondary {
    background: rgba(102, 126, 234, 0.2);
    color: var(--accent);
    border: 1px solid var(--accent);
  }

  .btn-secondary:hover {
    background: rgba(102, 126, 234, 0.3);
  }

  .input-group {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .input-field {
    flex: 1;
    min-width: 200px;
    background: var(--card);
    border: 1px solid rgba(102, 126, 234, 0.3);
    padding: 0.75rem;
    border-radius: 8px;
    color: var(--text);
    font-size: 1rem;
  }

  .input-field::placeholder {
    color: var(--muted);
  }

  .list-item {
    background: var(--card);
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid rgba(102, 126, 234, 0.3);
    margin-bottom: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .list-item-title {
    color: var(--text);
    font-weight: 600;
  }

  .list-item-meta {
    color: var(--muted);
    font-size: 0.9rem;
  }

  .badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    margin-left: 1rem;
  }

  .badge-success {
    background: rgba(61, 217, 143, 0.2);
    color: var(--good);
  }

  .badge-warning {
    background: rgba(249, 199, 79, 0.2);
    color: var(--medium);
  }

  .badge-danger {
    background: rgba(239, 83, 80, 0.2);
    color: var(--bad);
  }

  .action-buttons {
    display: flex;
    gap: 0.5rem;
  }

  .btn-icon {
    background: rgba(102, 126, 234, 0.1);
    border: none;
    color: var(--accent);
    width: 36px;
    height: 36px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1.2rem;
    transition: all 0.3s ease;
  }

  .btn-icon:hover {
    background: rgba(102, 126, 234, 0.3);
  }

  .section {
    background: var(--card);
    padding: 2rem;
    border-radius: 12px;
    border: 1px solid rgba(102, 126, 234, 0.3);
    margin-bottom: 2rem;
  }

  .section-title {
    color: var(--text);
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
  }

  .empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--muted);
  }

  .empty-state-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }

  @media (max-width: 768px) {
    .export-header h1 {
      font-size: 1.8rem;
    }

    .tabs {
      overflow-x: auto;
    }

    .format-buttons {
      flex-direction: column;
    }

    .btn {
      width: 100%;
    }
  }
</style>

<div class="page-header">
  <a href="/" class="back-link">‚Üê Retour √† l'accueil</a>
  <h1>üìä Export et Rapports</h1>
  <p>G√©rez vos exports de donn√©es et vos rapports d'analyse</p>
</div>

<div class="export-container">
  <!-- Tabs Navigation -->
  <div class="tabs">
    <button class="tab-button active" onclick="switchTab('exports')">Exports</button>
    <button class="tab-button" onclick="switchTab('reports')">Rapports</button>
    <button class="tab-button" onclick="switchTab('scheduled')">Programm√©s</button>
    <button class="tab-button" onclick="switchTab('history')">Historique</button>
  </div>

  <!-- Stats -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">Exports ce mois</div>
      <div class="stat-value" id="statsExports">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Rapports g√©n√©r√©s</div>
      <div class="stat-value" id="statsReports">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Espace utilis√©</div>
      <div class="stat-value" id="statsSpace">0 MB</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Expirations en attente</div>
      <div class="stat-value" id="statsExpiring">0</div>
    </div>
  </div>

  <!-- Tab: Exports -->
  <div id="exports" class="tab-content active">
    <div class="section">
      <div class="section-title">Cr√©er un nouvel export</div>
      
      <div class="input-group">
        <select id="exportFormat" class="input-field">
          <option value="">Format d'export</option>
          <option value="csv">üìÑ CSV</option>
          <option value="json">üî§ JSON</option>
          <option value="xlsx">üìä Excel</option>
          <option value="pdf">üìë PDF</option>
        </select>

        <select id="exportRange" class="input-field">
          <option value="">P√©riode</option>
          <option value="7days">7 derniers jours</option>
          <option value="30days">30 derniers jours</option>
          <option value="90days">90 derniers jours</option>
          <option value="all">Toutes les donn√©es</option>
        </select>

        <button class="btn btn-primary" onclick="createExport()">üíæ Exporter</button>
      </div>

      <div class="format-buttons">
        <button class="btn btn-secondary" onclick="quickExport('csv')">CSV rapide</button>
        <button class="btn btn-secondary" onclick="quickExport('xlsx')">Excel rapide</button>
        <button class="btn btn-secondary" onclick="quickExport('pdf')">PDF rapide</button>
        <button class="btn btn-secondary" onclick="quickExport('json')">JSON rapide</button>
      </div>
    </div>

    <div class="section" id="exportsListContainer" style="display:none;">
      <div class="section-title">Exports actifs</div>
      <div id="exportsList"></div>
    </div>

    <div class="section">
      <div id="noExports" class="empty-state">
        <div class="empty-state-icon">üì≠</div>
        <p>Aucun export en cours</p>
      </div>
    </div>
  </div>

  <!-- Tab: Reports -->
  <div id="reports" class="tab-content">
    <div class="section">
      <div class="section-title">G√©n√©rer un rapport</div>
      
      <div class="input-group">
        <select id="reportType" class="input-field">
          <option value="">Type de rapport</option>
          <option value="summary">R√©sum√© mensuel</option>
          <option value="detailed">Rapport d√©taill√©</option>
          <option value="comparison">Analyse comparative</option>
          <option value="trends">Tendances</option>
          <option value="health">Sant√© du syst√®me</option>
        </select>

        <input type="text" id="reportTitle" class="input-field" placeholder="Titre du rapport">
        
        <button class="btn btn-primary" onclick="generateReport()">üìÑ G√©n√©rer</button>
      </div>
    </div>

    <div class="section">
      <div class="section-title">Rapports disponibles</div>
      <div id="reportsList"></div>
      <div id="noReports" class="empty-state">
        <div class="empty-state-icon">üìÇ</div>
        <p>Aucun rapport disponible</p>
      </div>
    </div>
  </div>

  <!-- Tab: Scheduled -->
  <div id="scheduled" class="tab-content">
    <div class="section">
      <div class="section-title">Programmer un export</div>
      
      <div class="input-group">
        <select id="scheduleFormat" class="input-field">
          <option value="">Format</option>
          <option value="csv">CSV</option>
          <option value="xlsx">Excel</option>
          <option value="pdf">PDF</option>
        </select>

        <select id="scheduleFrequency" class="input-field">
          <option value="">Fr√©quence</option>
          <option value="daily">Quotidien</option>
          <option value="weekly">Hebdomadaire</option>
          <option value="monthly">Mensuel</option>
        </select>

        <input type="email" id="scheduleEmail" class="input-field" placeholder="Email de destination">

        <button class="btn btn-primary" onclick="scheduleExport()">‚è∞ Programmer</button>
      </div>
    </div>

    <div class="section">
      <div class="section-title">Exports programm√©s</div>
      <div id="scheduledList"></div>
      <div id="noScheduled" class="empty-state">
        <div class="empty-state-icon">‚è∞</div>
        <p>Aucun export programm√©</p>
      </div>
    </div>
  </div>

  <!-- Tab: History -->
  <div id="history" class="tab-content">
    <div class="section">
      <div class="section-title">Historique des exports</div>
      <div id="historyList"></div>
      <div id="noHistory" class="empty-state">
        <div class="empty-state-icon">‚è±Ô∏è</div>
        <p>Aucun historique disponible</p>
      </div>
    </div>
  </div>
</div>

<script>
  // Tab switching
  function switchTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

    // Show selected tab
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');

    // Load data for tab
    if (tabName === 'exports') loadExports();
    else if (tabName === 'reports') loadReports();
    else if (tabName === 'scheduled') loadScheduled();
    else if (tabName === 'history') loadHistory();
  }

  // Load initial data
  function loadInitialData() {
    loadStats();
    loadExports();
  }

  // Load statistics
  function loadStats() {
    fetch('/api/export/stats')
      .then(r => r.json())
      .then(data => {
        document.getElementById('statsExports').textContent = data.total_exports || 0;
        document.getElementById('statsReports').textContent = data.total_reports || 0;
        document.getElementById('statsSpace').textContent = (data.space_used || 0) + ' MB';
        document.getElementById('statsExpiring').textContent = data.expiring_soon || 0;
      })
      .catch(err => console.log('Stats load deferred'));
  }

  // Load exports
  function loadExports() {
    fetch('/api/export/list')
      .then(r => r.json())
      .then(data => {
        if (!data.exports || data.exports.length === 0) {
          document.getElementById('noExports').style.display = 'block';
          document.getElementById('exportsListContainer').style.display = 'none';
          return;
        }

        const html = data.exports.map(exp => `
          <div class="list-item">
            <div>
              <div class="list-item-title">${exp.name || 'Export'}</div>
              <div class="list-item-meta">${exp.format?.toUpperCase() || 'N/A'} ‚Ä¢ ${exp.size || '0'} MB</div>
            </div>
            <div class="action-buttons">
              <button class="btn-icon" onclick="downloadExport('${exp.id}')">‚¨áÔ∏è</button>
              <button class="btn-icon" onclick="deleteExport('${exp.id}')">üóëÔ∏è</button>
            </div>
          </div>
        `).join('');

        document.getElementById('exportsList').innerHTML = html;
        document.getElementById('exportsListContainer').style.display = 'block';
        document.getElementById('noExports').style.display = 'none';
      })
      .catch(err => {
        console.log('Export list error:', err);
        document.getElementById('noExports').style.display = 'block';
      });
  }

  // Load reports
  function loadReports() {
    fetch('/api/export/reports')
      .then(r => r.json())
      .then(data => {
        if (!data.reports || data.reports.length === 0) {
          document.getElementById('noReports').style.display = 'block';
          document.getElementById('reportsList').innerHTML = '';
          return;
        }

        const html = data.reports.map(rep => `
          <div class="list-item">
            <div>
              <div class="list-item-title">${rep.title || 'Rapport'}</div>
              <div class="list-item-meta">${rep.type || 'N/A'} ‚Ä¢ ${rep.created || 'N/A'}</div>
            </div>
            <div class="action-buttons">
              <button class="btn-icon" onclick="viewReport('${rep.id}')">üëÅÔ∏è</button>
              <button class="btn-icon" onclick="downloadReport('${rep.id}')">‚¨áÔ∏è</button>
            </div>
          </div>
        `).join('');

        document.getElementById('reportsList').innerHTML = html;
        document.getElementById('noReports').style.display = 'none';
      })
      .catch(err => {
        console.log('Reports error:', err);
        document.getElementById('noReports').style.display = 'block';
      });
  }

  // Load scheduled exports
  function loadScheduled() {
    fetch('/api/export/scheduled')
      .then(r => r.json())
      .then(data => {
        if (!data.scheduled || data.scheduled.length === 0) {
          document.getElementById('noScheduled').style.display = 'block';
          document.getElementById('scheduledList').innerHTML = '';
          return;
        }

        const html = data.scheduled.map(sch => `
          <div class="list-item">
            <div>
              <div class="list-item-title">${sch.name || 'Export programm√©'}</div>
              <div class="list-item-meta">${sch.frequency || 'N/A'} ‚Ä¢ ${sch.next_run || 'N/A'}</div>
            </div>
            <div class="action-buttons">
              <button class="btn-icon" onclick="editScheduled('${sch.id}')">‚úèÔ∏è</button>
              <button class="btn-icon" onclick="deleteScheduled('${sch.id}')">üóëÔ∏è</button>
            </div>
          </div>
        `).join('');

        document.getElementById('scheduledList').innerHTML = html;
        document.getElementById('noScheduled').style.display = 'none';
      })
      .catch(err => {
        console.log('Scheduled error:', err);
        document.getElementById('noScheduled').style.display = 'block';
      });
  }

  // Load history
  function loadHistory() {
    fetch('/api/export/history')
      .then(r => r.json())
      .then(data => {
        if (!data.history || data.history.length === 0) {
          document.getElementById('noHistory').style.display = 'block';
          document.getElementById('historyList').innerHTML = '';
          return;
        }

        const html = data.history.map(hist => `
          <div class="list-item">
            <div>
              <div class="list-item-title">${hist.action || 'Op√©ration'}</div>
              <div class="list-item-meta">${hist.timestamp || 'N/A'} ‚Ä¢ ${hist.details || ''}</div>
            </div>
            <div>${hist.status ? '<span class="badge badge-success">‚úì Succ√®s</span>' : '<span class="badge badge-danger">‚úó Erreur</span>'}</div>
          </div>
        `).join('');

        document.getElementById('historyList').innerHTML = html;
        document.getElementById('noHistory').style.display = 'none';
      })
      .catch(err => {
        console.log('History error:', err);
        document.getElementById('noHistory').style.display = 'block';
      });
  }

  // Create export
  function createExport() {
    const format = document.getElementById('exportFormat').value;
    const range = document.getElementById('exportRange').value;

    if (!format || !range) {
      alert('Veuillez s√©lectionner un format et une p√©riode');
      return;
    }

    fetch('/api/export/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ format, range })
    })
    .then(r => r.json())
    .then(data => {
      alert('Export cr√©√© avec succ√®s');
      loadExports();
    })
    .catch(err => alert('Erreur: ' + err.message));
  }

  // Quick export
  function quickExport(format) {
    fetch('/api/export/simulate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ format, range: '30days' })
    })
    .then(r => r.blob())
    .then(blob => {
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `export_${Date.now()}.${format}`;
      a.click();
      window.URL.revokeObjectURL(url);
    })
    .catch(err => alert('Erreur: ' + err.message));
  }

  // Generate report
  function generateReport() {
    const type = document.getElementById('reportType').value;
    const title = document.getElementById('reportTitle').value;

    if (!type) {
      alert('Veuillez s√©lectionner un type de rapport');
      return;
    }

    fetch('/api/export/report', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ type, title: title || type })
    })
    .then(r => r.json())
    .then(data => {
      alert('Rapport g√©n√©r√©');
      loadReports();
    })
    .catch(err => alert('Erreur: ' + err.message));
  }

  // Schedule export
  function scheduleExport() {
    const format = document.getElementById('scheduleFormat').value;
    const frequency = document.getElementById('scheduleFrequency').value;
    const email = document.getElementById('scheduleEmail').value;

    if (!format || !frequency || !email) {
      alert('Veuillez remplir tous les champs');
      return;
    }

    fetch('/api/export/schedule', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ format, frequency, email })
    })
    .then(r => r.json())
    .then(data => {
      alert('Export programm√©');
      loadScheduled();
    })
    .catch(err => alert('Erreur: ' + err.message));
  }

  // Download export
  function downloadExport(id) {
    window.location.href = `/api/export/download/${id}`;
  }

  // Delete export
  function deleteExport(id) {
    if (confirm('Supprimer cet export?')) {
      fetch(`/api/export/delete/${id}`, { method: 'DELETE' })
        .then(() => loadExports())
        .catch(err => alert('Erreur: ' + err.message));
    }
  }

  // View/Download report
  function viewReport(id) {
    window.location.href = `/api/export/report/${id}`;
  }

  function downloadReport(id) {
    window.location.href = `/api/export/report/download/${id}`;
  }

  // Edit scheduled
  function editScheduled(id) {
    alert('√âdition de l\'export programm√© ' + id);
  }

  // Delete scheduled
  function deleteScheduled(id) {
    if (confirm('Supprimer cet export programm√©?')) {
      fetch(`/api/export/schedule/${id}`, { method: 'DELETE' })
        .then(() => loadScheduled())
        .catch(err => alert('Erreur: ' + err.message));
    }
  }

  // Initialize on load
  document.addEventListener('DOMContentLoaded', loadInitialData);
</script>
{% endblock %}
