{% extends "base.html" %}

{% block content %}

<style>
.export-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

.export-header {
  margin-bottom: 30px;
}

.export-header h1 {
  color: #e5e7eb;
  font-size: 2.2rem;
  font-weight: 700;
  margin-bottom: 8px;
}

.export-tabs {
  display: flex;
  gap: 10px;
  border-bottom: 2px solid rgba(102, 126, 234, 0.3);
  margin-bottom: 30px;
}

.tab {
  padding: 12px 24px;
  background: transparent;
  border: none;
  color: #9ca3af;
  font-weight: 600;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
  transition: all 0.2s ease;
}

.tab.active {
  color: #4db8ff;
  border-bottom-color: #4db8ff;
}

.tab:hover {
  color: #4db8ff;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  color: #9ca3af;
  font-weight: 600;
  margin-bottom: 8px;
  font-size: 0.95rem;
}

.form-input, .form-select {
  width: 100%;
  padding: 12px 16px;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(102, 126, 234, 0.3);
  border-radius: 8px;
  color: #e5e7eb;
  font-size: 0.95rem;
}

.form-input:focus, .form-select:focus {
  outline: none;
  border-color: #4db8ff;
  background: rgba(77, 184, 255, 0.05);
}

.form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
}

.btn-primary {
  padding: 12px 24px;
  background: linear-gradient(135deg, #4db8ff, #667eea);
  border: none;
  border-radius: 8px;
  color: white;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(77, 184, 255, 0.3);
}

.btn-secondary {
  padding: 8px 16px;
  background: rgba(102, 126, 234, 0.2);
  border: 1px solid rgba(102, 126, 234, 0.3);
  border-radius: 6px;
  color: #667eea;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn-secondary:hover {
  background: rgba(102, 126, 234, 0.3);
}

.btn-danger {
  padding: 8px 16px;
  background: rgba(255, 107, 107, 0.2);
  border: 1px solid rgba(255, 107, 107, 0.3);
  border-radius: 6px;
  color: #ff6b6b;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn-danger:hover {
  background: rgba(255, 107, 107, 0.3);
}

.format-selector {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 15px;
  margin-top: 10px;
}

.format-option {
  padding: 20px;
  background: rgba(255, 255, 255, 0.03);
  border: 2px solid rgba(102, 126, 234, 0.2);
  border-radius: 8px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s ease;
}

.format-option:hover {
  border-color: rgba(77, 184, 255, 0.5);
  background: rgba(77, 184, 255, 0.05);
}

.format-option.selected {
  border-color: #4db8ff;
  background: rgba(77, 184, 255, 0.1);
}

.format-icon {
  font-size: 2rem;
  margin-bottom: 8px;
}

.format-name {
  color: #e5e7eb;
  font-weight: 600;
  font-size: 0.9rem;
}

.scheduled-list {
  display: grid;
  gap: 15px;
}

.scheduled-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(102, 126, 234, 0.2);
  border-radius: 8px;
}

.scheduled-info h3 {
  color: #e5e7eb;
  font-size: 1.1rem;
  margin-bottom: 8px;
}

.scheduled-details {
  color: #9ca3af;
  font-size: 0.9rem;
}

.scheduled-actions {
  display: flex;
  gap: 10px;
}

.checkbox-group {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 10px;
}

.checkbox-group input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.checkbox-group label {
  color: #9ca3af;
  cursor: pointer;
  margin-bottom: 0;
}

.history-table {
  width: 100%;
  border-collapse: collapse;
  color: #e5e7eb;
}

.history-table th {
  text-align: left;
  padding: 12px;
  background: rgba(102, 126, 234, 0.1);
  font-weight: 600;
  color: #9ca3af;
  border-bottom: 2px solid rgba(102, 126, 234, 0.3);
}

.history-table td {
  padding: 12px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.history-table tbody tr:hover {
  background: rgba(102, 126, 234, 0.05);
}
</style>

<div class="export-container">
  <div class="export-header">
    <h1>üì• Export de Donn√©es</h1>
    <p style="color: #9ca3af;">Exportez vos donn√©es dans diff√©rents formats</p>
  </div>

  <!-- Tabs -->
  <div class="export-tabs">
    <button class="tab active" onclick="switchTab('instant')">Export Instantan√©</button>
    <button class="tab" onclick="switchTab('scheduled')">Exports Programm√©s</button>
    <button class="tab" onclick="switchTab('custom')">Rapport Personnalis√©</button>
    <button class="tab" onclick="switchTab('history')">Historique</button>
  </div>

  <!-- Instant Export Tab -->
  <div id="instant-tab" class="tab-content active">
    <div class="card">
      <h2>Export Instantan√©</h2>
      <p style="color: #9ca3af; margin-bottom: 25px;">T√©l√©chargez vos donn√©es imm√©diatement</p>

      <form id="instant-export-form">
        <!-- Format Selection -->
        <div class="form-group">
          <label class="form-label">Format d'Export</label>
          <div class="format-selector">
            <div class="format-option selected" data-format="csv">
              <div class="format-icon">üìä</div>
              <div class="format-name">CSV</div>
            </div>
            <div class="format-option" data-format="json">
              <div class="format-icon">üìÑ</div>
              <div class="format-name">JSON</div>
            </div>
            <div class="format-option" data-format="excel">
              <div class="format-icon">üìó</div>
              <div class="format-name">Excel</div>
            </div>
            <div class="format-option" data-format="pdf">
              <div class="format-icon">üìï</div>
              <div class="format-name">PDF</div>
            </div>
          </div>
        </div>

        <!-- Date Range -->
        <div class="form-group">
          <label class="form-label">Plage de Dates</label>
          <div class="form-row">
            <div>
              <input type="date" id="start-date" class="form-input" placeholder="Date de d√©but">
            </div>
            <div>
              <input type="date" id="end-date" class="form-input" placeholder="Date de fin">
            </div>
          </div>
        </div>

        <button type="submit" class="btn-primary">
          <span>üì•</span> T√©l√©charger l'Export
        </button>
      </form>
    </div>
  </div>

  <!-- Scheduled Exports Tab -->
  <div id="scheduled-tab" class="tab-content">
    <div class="card">
      <h2>Exports Programm√©s</h2>
      <p style="color: #9ca3af; margin-bottom: 25px;">Configurez des exports automatiques r√©currents</p>

      <!-- Create New Schedule -->
      <form id="schedule-form" style="margin-bottom: 30px; padding-bottom: 30px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
        <div class="form-group">
          <label class="form-label">Nom de l'Export</label>
          <input type="text" id="schedule-name" class="form-input" placeholder="Ex: Export quotidien CO2" required>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Format</label>
            <select id="schedule-format" class="form-select">
              <option value="csv">CSV</option>
              <option value="json">JSON</option>
              <option value="excel">Excel</option>
              <option value="pdf">PDF</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Fr√©quence</label>
            <select id="schedule-frequency" class="form-select">
              <option value="daily">Quotidien</option>
              <option value="weekly">Hebdomadaire</option>
              <option value="monthly">Mensuel</option>
            </select>
          </div>
        </div>

        <div class="checkbox-group">
          <input type="checkbox" id="email-enabled">
          <label for="email-enabled">Envoyer par email</label>
        </div>

        <div class="form-group" id="email-group" style="display: none; margin-top: 15px;">
          <label class="form-label">Adresse Email</label>
          <input type="email" id="schedule-email" class="form-input" placeholder="votre@email.com">
        </div>

        <button type="submit" class="btn-primary" style="margin-top: 15px;">
          <span>‚ûï</span> Cr√©er Export Programm√©
        </button>
      </form>

      <!-- Scheduled Exports List -->
      <h3 style="color: #e5e7eb; margin-bottom: 20px;">Exports Actifs</h3>
      <div class="scheduled-list">
        {% if scheduled_exports %}
          {% for export in scheduled_exports %}
          <div class="scheduled-item">
            <div class="scheduled-info">
              <h3>{{ export.name }}</h3>
              <div class="scheduled-details">
                Format: {{ export.format.upper() }} | Fr√©quence: {{ export.frequency }} 
                {% if export.email_enabled %}| üìß Email activ√©{% endif %}
                <br>
                Prochain export: {{ export.next_run }}
              </div>
            </div>
            <div class="scheduled-actions">
              <button class="btn-secondary" onclick="toggleSchedule({{ export.id }})">
                {% if export.active %}D√©sactiver{% else %}Activer{% endif %}
              </button>
              <button class="btn-danger" onclick="deleteSchedule({{ export.id }})">Supprimer</button>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <p style="color: #9ca3af; text-align: center; padding: 40px 0;">Aucun export programm√©</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Custom Report Tab -->
  <div id="custom-tab" class="tab-content">
    <div class="card">
      <h2>Rapport Personnalis√©</h2>
      <p style="color: #9ca3af; margin-bottom: 25px;">Cr√©ez un rapport avec des filtres avanc√©s</p>

      <form id="custom-report-form">
        <!-- Date Range -->
        <div class="form-group">
          <label class="form-label">Plage de Dates</label>
          <div class="form-row">
            <input type="date" id="custom-start" class="form-input">
            <input type="date" id="custom-end" class="form-input">
          </div>
        </div>

        <!-- CO2 Range -->
        <div class="form-group">
          <label class="form-label">Plage CO‚ÇÇ (ppm)</label>
          <div class="form-row">
            <input type="number" id="min-ppm" class="form-input" placeholder="Min (ex: 400)">
            <input type="number" id="max-ppm" class="form-input" placeholder="Max (ex: 2000)">
          </div>
        </div>

        <!-- Aggregation -->
        <div class="form-group">
          <label class="form-label">Agr√©gation des Donn√©es</label>
          <select id="aggregation" class="form-select">
            <option value="none">Aucune (donn√©es brutes)</option>
            <option value="hourly">Horaire (moyennes par heure)</option>
            <option value="daily">Quotidienne (moyennes par jour)</option>
            <option value="weekly">Hebdomadaire (moyennes par semaine)</option>
          </select>
        </div>

        <!-- Format -->
        <div class="form-group">
          <label class="form-label">Format d'Export</label>
          <div class="format-selector">
            <div class="format-option selected" data-format="csv">
              <div class="format-icon">üìä</div>
              <div class="format-name">CSV</div>
            </div>
            <div class="format-option" data-format="json">
              <div class="format-icon">üìÑ</div>
              <div class="format-name">JSON</div>
            </div>
            <div class="format-option" data-format="excel">
              <div class="format-icon">üìó</div>
              <div class="format-name">Excel</div>
            </div>
            <div class="format-option" data-format="pdf">
              <div class="format-icon">üìï</div>
              <div class="format-name">PDF</div>
            </div>
          </div>
        </div>

        <button type="submit" class="btn-primary">
          <span>üì•</span> G√©n√©rer Rapport Personnalis√©
        </button>
      </form>
    </div>
  </div>

  <!-- History Tab -->
  <div id="history-tab" class="tab-content">
    <div class="card">
      <h2>Historique des Exports</h2>
      <p style="color: #9ca3af; margin-bottom: 25px;">Vos exports r√©cents</p>

      {% if export_history %}
      <div style="overflow-x: auto;">
        <table class="history-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Format</th>
              <th>Nom du Fichier</th>
              <th>Taille</th>
            </tr>
          </thead>
          <tbody>
            {% for export in export_history %}
            <tr>
              <td>{{ export.created_at }}</td>
              <td>{{ export.export_type }}</td>
              <td><span style="text-transform: uppercase; font-weight: 600;">{{ export.format }}</span></td>
              <td style="font-family: monospace; color: #9ca3af;">{{ export.filename }}</td>
              <td>{{ (export.file_size / 1024)|round(1) }} KB</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p style="color: #9ca3af; text-align: center; padding: 40px 0;">Aucun export dans l'historique</p>
      {% endif %}
    </div>
  </div>

</div>

<script>
// Tab Switching
function switchTab(tabName) {
  // Hide all tab contents
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
  });

  // Remove active class from all tabs
  document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.remove('active');
  });

  // Show selected tab content
  document.getElementById(tabName + '-tab').classList.add('active');

  // Add active class to clicked tab
  event.target.classList.add('active');
}

// Format Selection
document.querySelectorAll('.format-option').forEach(option => {
  option.addEventListener('click', function() {
    // Remove selected class from siblings
    this.parentElement.querySelectorAll('.format-option').forEach(opt => {
      opt.classList.remove('selected');
    });

    // Add selected class to clicked option
    this.classList.add('selected');
  });
});

// Email Enable/Disable
document.getElementById('email-enabled').addEventListener('change', function() {
  document.getElementById('email-group').style.display = this.checked ? 'block' : 'none';
});

// Instant Export Form
document.getElementById('instant-export-form').addEventListener('submit', async function(e) {
  e.preventDefault();

  const selectedFormat = document.querySelector('#instant-tab .format-option.selected').dataset.format;
  const startDate = document.getElementById('start-date').value;
  const endDate = document.getElementById('end-date').value;

  const response = await fetch('/data-export/instant', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      format: selectedFormat,
      start_date: startDate,
      end_date: endDate
    })
  });

  if (response.ok) {
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `co2_export_${new Date().toISOString().slice(0,10)}.${selectedFormat}`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    alert('Export t√©l√©charg√© avec succ√®s!');
  } else {
    alert('Erreur lors de l\'export');
  }
});

// Schedule Export Form
document.getElementById('schedule-form').addEventListener('submit', async function(e) {
  e.preventDefault();

  const data = {
    name: document.getElementById('schedule-name').value,
    format: document.getElementById('schedule-format').value,
    frequency: document.getElementById('schedule-frequency').value,
    email_enabled: document.getElementById('email-enabled').checked,
    email_address: document.getElementById('schedule-email').value
  };

  const response = await fetch('/data-export/schedule', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  });

  const result = await response.json();

  if (result.success) {
    alert('Export programm√© cr√©√© avec succ√®s!');
    location.reload();
  } else {
    alert('Erreur: ' + result.error);
  }
});

// Toggle Schedule
async function toggleSchedule(exportId) {
  const response = await fetch(`/data-export/schedule/${exportId}/toggle`, {
    method: 'POST'
  });

  const result = await response.json();

  if (result.success) {
    location.reload();
  } else {
    alert('Erreur lors de la modification');
  }
}

// Delete Schedule
async function deleteSchedule(exportId) {
  if (!confirm('√ätes-vous s√ªr de vouloir supprimer cet export programm√©?')) {
    return;
  }

  const response = await fetch(`/data-export/schedule/${exportId}`, {
    method: 'DELETE'
  });

  const result = await response.json();

  if (result.success) {
    alert('Export programm√© supprim√©');
    location.reload();
  } else {
    alert('Erreur lors de la suppression');
  }
}

// Custom Report Form
document.getElementById('custom-report-form').addEventListener('submit', async function(e) {
  e.preventDefault();

  const selectedFormat = document.querySelector('#custom-tab .format-option.selected').dataset.format;

  const data = {
    format: selectedFormat,
    start_date: document.getElementById('custom-start').value,
    end_date: document.getElementById('custom-end').value,
    min_ppm: document.getElementById('min-ppm').value,
    max_ppm: document.getElementById('max-ppm').value,
    aggregation: document.getElementById('aggregation').value
  };

  const response = await fetch('/data-export/custom-report', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  });

  if (response.ok) {
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `custom_report_${new Date().toISOString().slice(0,10)}.${selectedFormat}`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    alert('Rapport personnalis√© g√©n√©r√©!');
  } else {
    alert('Erreur lors de la g√©n√©ration du rapport');
  }
});
</script>

{% endblock %}
